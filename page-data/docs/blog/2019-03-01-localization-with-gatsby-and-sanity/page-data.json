{"componentChunkName":"component---src-templates-blog-post-js","path":"/docs/blog/2019-03-01-localization-with-gatsby-and-sanity/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"85b786b0-4156-54a9-a261-9503c7ef61a2","excerpt":"Localization is a common problem and there are many solutions, each with their own benefits and trade-offs. With Gatsby and Sanity.io its possible to achieve a…","html":"<p>Localization is a common problem and there are <em>many</em> solutions, each with their own benefits and trade-offs. With Gatsby and Sanity.io its possible to achieve a solution that is easy to work with and extend. If you haven’t already read about why Gatsby and Sanity.io pair so well check out the blog post by <a href=\"/gatsby-bloga-2/contributors/knut-melvaer/\">Knut Melvær</a>: <a href=\"/gatsby-bloga-2/blog/2019-01-25-blazing-fast-development-with-gatsby-and-sanity-io\">Blazing fast development with Gatsby and Sanity.io</a>.</p>\n<p>I have completed two sites with Gatsby and Sanity that required localization. The first site needed to maintain every link from the original site without redirects: each language living in its own subdomain, <code class=\"language-text\">es.my-web-page.com</code> for example. The simplest solution at the time was to use multiple builds which always bothered me. The second site I vowed to do it the <em>right™</em> way.</p>\n<p>The new setup would generate pages for every language in one build step giving urls like <code class=\"language-text\">my-home-page.com/es/...</code>. This makes it easier for both the content team and our developers to use.</p>\n<h2>Setting Up Sanity to Support Translations</h2>\n<p>Sanity.io has some good documentation which has great examples to help you achieve <a href=\"https://www.sanity.io/docs/localization\">localized</a> text.</p>\n<p>Create a new contentType schema called <code class=\"language-text\">localeText</code> to use with the schemas in your project.</p>\n<div class=\"gatsby-highlight\" data-language=\"js:title=contenttypes/localetext.js\"><pre class=\"language-js:title=contenttypes/localetext.js\"><code class=\"language-js:title=contenttypes/localetext.js\">const supportedLanguages = [\n  { id: &quot;en&quot;, title: &quot;English&quot;, isDefault: true },\n  { id: &quot;es&quot;, title: &quot;Spanish&quot; },\n  // Add as many languages as you need to support\n]\n\nexport default {\n  name: &quot;localeString&quot;,\n  type: &quot;object&quot;,\n  fieldsets: [\n    {\n      title: &quot;Translations&quot;,\n      name: &quot;translations&quot;,\n      options: { collapsible: true },\n    },\n  ],\n  fields: supportedLanguages.map(lang =&gt; ({\n    title: lang.title,\n    name: lang.id,\n    type: &quot;string&quot;,\n    fieldset: lang.isDefault ? null : &quot;translations&quot;,\n  })),\n}</code></pre></div>\n<p>This will allow you to add <code class=\"language-text\">localeText</code> as a type in your schemas and renders a nice UI for adding translations.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/gatsby-bloga-2/static/bf3032542d0bea17bafd79fd3bd23e2b/0786c/ui-example.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAAAhklEQVQoz6WRSwrAIAxEc/+bCrrxL35SRoi0u7YJjGLQl4kh5xx77xmx1mJtUM6ZQwg8xtjAOadK1HtnYwzHGHcFJAH+I5giLBIah+DAHOHQWmO0XkrROwQgpcQYDoQqaiCGYq097u77G8nd3TKotdZHu1//T95sh6BKEom/AucMRQMSCecCeoUW0poNpu4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Example of the translation UI from Sanity\"\n        title=\"Example of the translation UI from Sanity\"\n        src=\"/gatsby-bloga-2/static/bf3032542d0bea17bafd79fd3bd23e2b/fcda8/ui-example.png\"\n        srcset=\"/gatsby-bloga-2/static/bf3032542d0bea17bafd79fd3bd23e2b/12f09/ui-example.png 148w,\n/gatsby-bloga-2/static/bf3032542d0bea17bafd79fd3bd23e2b/e4a3f/ui-example.png 295w,\n/gatsby-bloga-2/static/bf3032542d0bea17bafd79fd3bd23e2b/fcda8/ui-example.png 590w,\n/gatsby-bloga-2/static/bf3032542d0bea17bafd79fd3bd23e2b/0786c/ui-example.png 663w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>In your schema:</p>\n<div class=\"gatsby-highlight\" data-language=\"js:title=schemas/article.js\"><pre class=\"language-js:title=schemas/article.js\"><code class=\"language-js:title=schemas/article.js\">export default {\n  name: &quot;someDataType&quot;,\n  title: &quot;Data Title&quot;,\n  type: &quot;document&quot;,\n  fields: [\n    {\n      type: &quot;localeString&quot;,\n      name: &quot;title&quot;,\n    },\n    {\n      type: &quot;localeText&quot;,\n      name: &quot;description&quot;,\n    },\n  ],\n}</code></pre></div>\n<h2>Updating Gatsby Setup</h2>\n<p>Now that you have your Sanity schemas set up for adding translations you need to set up your Gatsby project to handle them. You’re going to update the queries to handle the new shape of your data.</p>\n<div class=\"gatsby-highlight\" data-language=\"js:title=src/pages/index.js\"><pre class=\"language-js:title=src/pages/index.js\"><code class=\"language-js:title=src/pages/index.js\">export const query = graphql`\n  query MyPageQuery {\n    sanitySomeDataType {\n      title {\n        _type\n        en\n        es\n      }\n    }\n  }\n`</code></pre></div>\n<p>Which gives you a data prop that looks like the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n  data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    sanitySomeDataType<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      title<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        _type<span class=\"token operator\">:</span> <span class=\"token string\">\"localeText\"</span><span class=\"token punctuation\">,</span>\n        en<span class=\"token operator\">:</span> <span class=\"token string\">\"My Title\"</span><span class=\"token punctuation\">,</span>\n        es<span class=\"token operator\">:</span> <span class=\"token string\">\"Mi título\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Getting the Correct Language Text</h2>\n<p>At this point you could use the above as-is in your components with <code class=\"language-text\">data.sanitySomeDataType.title.en</code>. You could do something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Component</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token punctuation\">{</span>\n    data<span class=\"token punctuation\">.</span>sanitySomeDataType<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">[</span>\n      props<span class=\"token punctuation\">.</span>pageContext<span class=\"token punctuation\">.</span>locale <span class=\"token operator\">||</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">GATSBY_LOCALE</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n  </span><span class=\"token punctuation\">{</span><span class=\"token comment\">/*Or anything else you wanted to do*/</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Component</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>It is preferable to reference only the title key and get the correct text. No need to remember what locale is active.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Component</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>data<span class=\"token punctuation\">.</span>sanitySomeDataType<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Component</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>So let’s make <em>that</em> work.</p>\n<p>Once again, you can use the example from the Sanity.io documentation for <a href=\"https://www.sanity.io/docs/localization#code-snippet-deeply-localizing-an-entire-document\">a function to localize</a> the text from a given Sanity document. I’ve modified the example below to always default to English. This suits my use case and it’s a good starting point if your use case differs. The function walks through a given document and updates any object with <code class=\"language-text\">_type: &#39;locale&lt;TEXT_TYPE&gt;&#39;</code> ( for example <code class=\"language-text\">_type: &#39;localeText&#39;</code>, or <code class=\"language-text\">_type: &#39;localeString&#39;</code> ) and returns only the correct translation text.</p>\n<div class=\"gatsby-highlight\" data-language=\"js:title=src/util/index.js\"><pre class=\"language-js:title=src/util/index.js\"><code class=\"language-js:title=src/util/index.js\">export const createLocaleTextGetter = languageCode =&gt; {\n  const languages = [languageCode, &quot;en&quot;] // last language in array is default;\n  const localize = value =&gt; {\n    if (Array.isArray(value)) {\n      return value.map(v =&gt; localize(v, languages))\n    } else if (typeof value == &quot;object&quot;) {\n      if (/^locale[A-Z]/.test(value._type)) {\n        const language = languages.find(lang =&gt; value[lang])\n        return value[language]\n      }\n\n      return Object.keys(value).reduce((result, key) =&gt; {\n        result[key] = localize(value[key], languages)\n        return result\n      }, {})\n    }\n    return value\n  }\n\n  return localize\n}</code></pre></div>\n<p>You could use render props for this but I decided on a higher-order component (HOC).</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=src/components/localize.jsx\"><pre class=\"language-jsx:title=src/components/localize.jsx\"><code class=\"language-jsx:title=src/components/localize.jsx\">import React from &quot;react&quot;\nimport Proptypes from &quot;prop-types&quot;\nimport { createLocaleTextGetter } from &quot;../../util&quot; // Or wherever you stashed it\n\nfunction localize(Component) {\n  return class Localize extends React.Component {\n    static propTypes = {\n      data: Proptypes.object,\n      pageContext: Proptypes.shape({\n        locale: Proptypes.string,\n      }),\n    }\n    constructor(props) {\n      super(props)\n\n      this.getLocalizedContent = createLocaleTextGetter(\n        this.props.pageContext.locale\n      )\n    }\n\n    render() {\n      return (\n        &lt;Component\n          {...this.props}\n          data={this.getLocalizedContent(this.props.data)}\n        /&gt;\n      )\n    }\n  }\n}\n\nexport default localize</code></pre></div>\n<h2>Wrap Page Components With the Localize HOC</h2>\n<p>For each page or template that needs to be localized add your HOC.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=src/pages/index.js\"><pre class=\"language-jsx:title=src/pages/index.js\"><code class=\"language-jsx:title=src/pages/index.js\">import React from &quot;react&quot;\nimport Layout from &quot;../components/Layout&quot;\nimport localize from &quot;../components/localize&quot;\n\nconst IndexPage = ({ data }) =&gt; (\n  &lt;Layout&gt;\n    &lt;h1&gt;{data.sanitySomeDataType.title}&lt;/h1&gt;\n  &lt;/Layout&gt;\n)\n\nexport default localize(IndexPage)\n\nexport const query = graphql`\n  query HomeQuery {\n    sanitySomeDataType {\n      title {\n        _type\n        en\n        es\n      }\n    }\n  }\n`</code></pre></div>\n<h2>Generating Pages with the Correct Context</h2>\n<p>In the <code class=\"language-text\">gatsby-node.js</code> file you need to add a function that generates pages for each supported language with a path prefix for each, such as ‘es’ for Spanish, and ‘fr’ for French. It needs to be called in <code class=\"language-text\">onCreatePage</code> so that every automatically generated page from your <code class=\"language-text\">pages</code> directory gets localized. It also needs to be added into the <code class=\"language-text\">createPages</code> to localize all of your dynamic content. This is needed as gatsby doesn’t call <code class=\"language-text\">onCreatePage</code> for pages generated by the same plugin at the moment to avoid infinite loops.</p>\n<div class=\"gatsby-highlight\" data-language=\"js:title=gatsby-node.js\"><pre class=\"language-js:title=gatsby-node.js\"><code class=\"language-js:title=gatsby-node.js\">// Get your list of languages from somewhere, env file, config.json, etc\n// for sake of this snippet I am putting it here\n\nconst extraLanguages = [&quot;es&quot;] // English is currently the default so it isn&#39;t needed here.\n\nconst createLocalePage = (page, createPage) =&gt; {\n  const { context, ...rest } = page\n\n  createPage({\n    ...rest,\n    context: {\n      ...context,\n      locale: process.env.LOCALE,\n    },\n  })\n\n  if (extraLanguages.length) {\n    extraLanguages.forEach(code =&gt; {\n      const { path, context, ...rest } = page\n\n      createPage({\n        ...rest,\n        path: `/${code}${path}`,\n        // every page for each language gets the language code as a prefix\n        // to its path: &quot;/es/blog/&lt;some-slug&gt;&quot; for example\n        context: {\n          ...context,\n          locale: code,\n        },\n      })\n    })\n  }\n}\n\nexports.createPages = ({ actions }) =&gt; {\n  const { createPage } = actions\n\n  // generate your dynamic content here...\n  const page = {\n    path: &quot;some-page&quot;,\n    component: path.resolve(`./src/templates/some-page.js`),\n    context: {\n      slug: &quot;some-page-slug&quot;,\n    },\n  }\n\n  createLocalePage(page, createPage)\n}\n\nexports.onCreatePage = ({ page, actions }) =&gt; {\n  const { createPage, deletePage } = actions\n\n  deletePage(page)\n\n  createLocalePage(page, createPage)\n}</code></pre></div>\n<h2>Sanity.io + Gatsby.js + Localization = Win</h2>\n<p>If you haven’t already started using <a href=\"https://www.sanity.io\">Sanity.io</a> as your content backend I encourage you to check it out. You and your content team will love it.</p>\n<p>For a quick start with the combo, the peeps at Sanity put up a great starting point at <a href=\"https://github.com/sanity-io/example-company-website-gatsby-sanity-combo\">Combo Example: Company Website</a></p>\n<p>If you have any questions or want to geek out about all things React hit me up on Twitter <a href=\"https://twitter.com/cpt_silverfox\">@cpt_silverfox</a></p>","frontmatter":{"title":"A method for Localization with Gatsby and Sanity.io","date":"March 01, 2019","description":null}}},"pageContext":{"slug":"/docs/blog/2019-03-01-localization-with-gatsby-and-sanity/","previous":{"fields":{"slug":"/docs/blog/2019-02-27-reactiflux-q-and-a/"},"frontmatter":{"title":"Q and A: Reactiflux and the Gatsby Team"}},"next":{"fields":{"slug":"/docs/blog/2019-03-04-new-schema-customization/"},"frontmatter":{"title":"New schema customization API in Gatsby"}}}}}