{"componentChunkName":"component---src-templates-blog-post-js","path":"/docs/blog/2020-04-13-upgrading-to-jamstack-with-agility/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"de573bd6-c50c-5c22-b881-6f8d18d5ec72","excerpt":"I’ve been preaching about JAMStack for a while now, and lately I’ve been talking a lot about how you can move your website to JAMStack without rebuilding…","html":"<p>I’ve been preaching about JAMStack for a while now, and lately I’ve been talking a lot about how you can <a href=\"https://agilitycms.com/resources/posts/migrate-to-jamstack-now-no-excuses\">move your website to JAMStack without rebuilding everything</a>.</p>\n<p>I decided it was time to take my own advice and upgrade my company’s website, <a href=\"https://agilitycms.com\">agilitycms.com</a>, starting with the home page, and adding pages and sections over time. Agility CMS is a headless content management system running in the cloud (Microsoft Azure). The current website is built on ASP.NET Core. Our marketing team came to me with a request to build a brand new home page which included not only updating content, but a brand new design, new modules, and new integrations with mar-tech.</p>\n<p>This was just the opportunity I’d been looking for: A chance to practice what I’ve been preaching! What’s also great is the current .NET website is already built using a headless CMS, so I don’t have to rewrite or migrate any content.</p>\n<h2>Goals</h2>\n<ul>\n<li>Build the new home page using <a href=\"https://www.gatsbyjs.org/\">Gatsby</a></li>\n<li>Re-use much of the existing site content from <a href=\"https://agilitycms.com/\">our headless CMS</a></li>\n<li>Zero downtime</li>\n</ul>\n<h2>tl;dr</h2>\n<p>For those of you who just want to see the code for the new site (it only has code for the modules that are on the homepage right now, but it will expand over time), it’s all here on GitHub: <a href=\"https://github.com/agility/agility-website-gatsby\">https://github.com/agility/agility-website-gatsby</a>.</p>\n<h2>Steps</h2>\n<p>Here’s what I did to get everything up and running, right from coding the new site, to deploying, testing and flipping over the DNS.</p>\n<ul>\n<li><a href=\"#step-1-get-it-running-locally-with-gatsby\">Get it running locally with Gatsby</a></li>\n<li><a href=\"#step-2-implement-the-header-and-footer\">Implement the Header and Footer</a></li>\n<li><a href=\"#step-3-create-a-new-home-page\">Create a new Home Page</a></li>\n<li><a href=\"#step-4-run-it-in-gatsby-cloud\">Run it in Gatsby Cloud</a></li>\n<li><a href=\"#step-5-deploy-to-netlify\">Deploy to Netlify</a></li>\n<li><a href=\"#step-6-setup-the-cdn-to-do-the-edge-routing\">Setup the CDN to do the Edge Routing</a></li>\n</ul>\n<p>What’s really cool is that this workflow isn’t just for upgrading Agility websites to JAMstack - you can use it for any website! Now let’s break each step into specific details.</p>\n<h2>Step 1: Get it running locally with Gatsby</h2>\n<p>It’s really easy to get started creating a Gatsby website with Agility CMS. Just clone the <a href=\"https://github.com/agility/agility-gatsby-starter\">starter repo from GitHub</a>, open up the folder in <a href=\"https://code.visualstudio.com/\">VS Code</a> and pop in your API Keys.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">git</span> clone https://github.com/agility/agility-gatsby-starter.git</code></pre></div>\n<p>Now, find your API Keys on the Getting Started page of the <a href=\"https://manager.agilitycms.com/\">Agility CMS Content Manager</a></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/gatsby-bloga-2/static/626f7a46404c3a8259033126b0dd8ab2/9c177/post-image-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.5945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAAC80lEQVQoz2WRa0iTURjHjxeyQEErqKQo6Et9UjMa3iotiygRpytTzGmlrhxGRN/60pcsCVToppbXXd53m1uZkpi5NHJbE0Wamb7b3CWdtOt72fbO+a6zmRX058/heQ7nd57nPAdkHjtYxuEWZlWcTefkHDqfn1bc3oj2t42iz4ffdI4NdCn/GKbcAn7G4XMXjrALUorYhaUgN58leTzBS5A1JPc3JCtuJSt4O5DaJGH11r5y0F0OejbXsKtjxbVx0ppt0gqADD7VghOns8UPldfikBs7JbwklLcdrd8l4+/p5yVKrm5BqmLEEKjaNDdaWBklrIwRXgI98ubPIPdMDvIIwpK6RCk3VsSNFnOjRNwocUWUsBR0c0AXG7QVgRds0L7hEtBxJab3IuiUN0+C46cyIQzbrklA0HtazQA2Lvim7NV9FMxpFaYpuVmFGn4bMahlhpFnurpEUQl4qWiZDLcN4bp42fV4ZPqdkQ7hlB/3rRG+IMGEmNA/YtbDqXuV5CejxRBuDVfOgnB1NFIBBOp+PUXjLoeHJCjcjTvsTsJD2FZWzUtWI2Y2GS0Op2PZYL+5V1AM2hUtKpCTl4k2KblAXAa61XKMZihIQpEkCVeXyzUzM6Od0kzPflGrVbq5rxbMxt+HcEDn61YVyM7LEDWOXQZ9JeDVpBSjAuHKFOUlIrLbHYalhSFUc5ej+DA4ZbQsmuZX4F+wQbccvjn7ZIbiyac7+9/yd8tm35tCIZ+fDhf2eDxut5sgSIfzp37+x8TQwhK2Ap9iMzsf5A/fPqAYbFMDFou1+B0LUIxrmdSOmpvqxzvua3C3Nxhc8/v9of8UoAPGBbNpcRlSID39qF6vDw+TWbdZXJMjep1meT349zRsw+P24DjJRGYfDAZpmoaBxWIBKSmpEZjxUiRN+7w07g+ER4XjuNPpZBgGBg67HU5uY34whQGErVYrSE1Nw7CFNZogPHafjwoE1mg/vJqGPcNDEIalAhHBTW9EkIcxhH8B/hU8QymCWUwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Agility CMS Getting Started landing page\"\n        title=\"Agility CMS Screenshot\"\n        src=\"/gatsby-bloga-2/static/626f7a46404c3a8259033126b0dd8ab2/fcda8/post-image-1.png\"\n        srcset=\"/gatsby-bloga-2/static/626f7a46404c3a8259033126b0dd8ab2/12f09/post-image-1.png 148w,\n/gatsby-bloga-2/static/626f7a46404c3a8259033126b0dd8ab2/e4a3f/post-image-1.png 295w,\n/gatsby-bloga-2/static/626f7a46404c3a8259033126b0dd8ab2/fcda8/post-image-1.png 590w,\n/gatsby-bloga-2/static/626f7a46404c3a8259033126b0dd8ab2/9c177/post-image-1.png 880w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Put your API Keys into the <strong>.env.development</strong> and <strong>.env.production</strong> files. They look something like this and have instructions about which values go where.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># Your Instance Id\nAGILITY_GUID=\n\n# Your Preview API Key (recommended) - you can get this from the Getting Started Page in Agility CMS\nAGILITY_API_KEY=\n\n# If using your Preview API Key, set this to true\nAGILITY_API_ISPREVIEW=true\n\n# If you want to enable &lt;host&gt;/__refresh endpoint\nENABLE_GATSBY_REFRESH_ENDPOINT=true</code></pre></div>\n<p>Now, check out the <strong>gatsby-config.js</strong> file - it has a section for plugins, and the Agility CMS source plugin is called <strong>@agility/gatsby-source-agilitycms</strong>. Check that the language code and channel name matches what you have in your Agility CMS instance.</p>\n<h3>Modules and Page Templates</h3>\n<p>Since this was an existing website, we already had a few Page Templates and Module Definitions set up in the instance. We need to make sure we at least have placeholders in our new Gatsby project for those, and we’ll just implement whatever is needed for our new home page.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 414px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/gatsby-bloga-2/static/cfe18f342e3168f95aa1d550426bb412/b910a/post-image-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAACDUlEQVQ4y42UXYvTQBSG8x/9Ad7ohe6iXdAVrwXvvNLudldx/4XQglvssn5Bm6TpppNMJt9J8zHJZJqisLslnrQIi9I2Ly/DEHjmvCc5E6Hb7X77ejn4cj4YDHq93sVK/X5fVVVd17WtEuSxUqRBoP0MwiiJ47Is5/P5YrEoGgjgMQ1n+mhITJOmKeccnjLGGsFjSYmYP5l999zA933HcUFNYXE8KSOLiZ+ukG4YmOW1imYSFEnxMu+Hc2kTJwiCdeym8ERWSGyf40Ea2AWvu92dmfM8S2kaCbIsxzRB6oVt6tDv+m3vrLmuIUiSCD3G088AY0wcpw7fNPZIlBLKonHX1NFERbbjhmEExzWxQHRp+TtTQ9lzpzz1qtuyWs6rm2KHr2sL918NWx1272T6qO2/PGOHZ3yvzfba+eN32Ua/zfaPsv3jXHjwevjsAzs8Hj5/H774ODvohA/f+E+OaOskf9rJNrl1mh2c5oKJpeqa3VCliNDM1fKIJD76VfjVsqiqebXk9eZ/39YWhiMxLxYs80NPV6dY040rFYEt2w1ncZzQLC82WZBEkfOSUzvyNaRhuIYIIULgmpgY48DfNnN/4cxNQoMQyzQJwHBEHMerYdr6ne/AxHY8gKGmZVlopSRJGlWOA7yCTdu2Yc4wzBs2KKX8jjbBDsAQmxADMgMP67pzWGEPfyWI8w/8B5i3IrNZPZwtAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Project Folder Structure\"\n        title=\"Project Folder Structure\"\n        src=\"/gatsby-bloga-2/static/cfe18f342e3168f95aa1d550426bb412/b910a/post-image-2.png\"\n        srcset=\"/gatsby-bloga-2/static/cfe18f342e3168f95aa1d550426bb412/12f09/post-image-2.png 148w,\n/gatsby-bloga-2/static/cfe18f342e3168f95aa1d550426bb412/e4a3f/post-image-2.png 295w,\n/gatsby-bloga-2/static/cfe18f342e3168f95aa1d550426bb412/b910a/post-image-2.png 414w\"\n        sizes=\"(max-width: 414px) 100vw, 414px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>There are folders for Page Templates and Modules, and you can just put in placeholder React code for these right now.</p>\n<p>Here’s an example Page Template component with a single content zone called “Main”:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">\"react\"</span>\n<span class=\"token keyword\">import</span> ContentZone <span class=\"token keyword\">from</span> <span class=\"token string\">\"../agility/components/ContentZone\"</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">MainTemplate</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">props</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>main-template<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ContentZone</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>Main<span class=\"token punctuation\">\"</span></span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token punctuation\">...</span><span class=\"token attr-value\">props</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> MainTemplate</code></pre></div>\n<p>Here’s an example Module component that doesn’t do anything except output its name.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">\"react\"</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">LatestResources</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> item <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>section</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>container<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">LatestResources</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>section</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> LatestResources</code></pre></div>\n<p>When I got all those things in place, I started up Gatsby to see what would happen.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">gatsby develop</code></pre></div>\n<p>Gatsby will pull down all the content for our website and put it into GraphQL. This is a <em>content sync</em>, so from now on it will only pull down a delta (what’s changed) from Agility CMS.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 499px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/gatsby-bloga-2/static/e48658397d8df721a031134d55a97e81/119c7/post-image-3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAABZUlEQVQoz32S25KbMAyGef8329502mYhwGIj+czZJhAcNrtVksn0Ynf6D8PIRp+MfjkZ/eg6J5W01g7DoO+igJZd1xlj2rZ1ztHmOI5N04QQPp9K9KrKJQcLAgUJEQmgNwA8avV9P00TBTHGy+Wy7/s/GLc6jX9Ej1VZ1VDTOURSlXVdr9fr53+V2KirWNjRaKmllPSrBC/LQjGVeCR93PUNDJEf4i/o4JgesywryoK6VUoVRTH5aX/fz+fzt+QNNpPhPVNaGWmUUMgBQQiQwKFru8Y1ZVlSL6fT6WsXSe6Ph+nwo38x0fBT9dv/fAtlHlJcYN5C2ELcIpHk1uP8j6dusPBYDaxo837pTNB8YOgBR7SzxR5ccOuyEDzP81cLk5rV5HN6SJ11EiXFWCNtImD2mrE3xjnP85wmNz9FoyZH73PWmlxljN3uQNsIKYw1lh5nCaCvNHZKoCls2+a9J5IyH1flL5+iLh2dcylTAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Alt Text\"\n        title=\"Agility CMS - Gatsby - Terminal Output\"\n        src=\"/gatsby-bloga-2/static/e48658397d8df721a031134d55a97e81/119c7/post-image-3.png\"\n        srcset=\"/gatsby-bloga-2/static/e48658397d8df721a031134d55a97e81/12f09/post-image-3.png 148w,\n/gatsby-bloga-2/static/e48658397d8df721a031134d55a97e81/e4a3f/post-image-3.png 295w,\n/gatsby-bloga-2/static/e48658397d8df721a031134d55a97e81/119c7/post-image-3.png 499w\"\n        sizes=\"(max-width: 499px) 100vw, 499px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Step 2: Implement the Header and Footer</h2>\n<p>We need to make our new website look just like the old one, so we need to match the colors, fonts, and other visual styles as much as we can. You may want to pull in the CSS from your old site—or start from scratch if you want to make a clean break.</p>\n<p>Either way, this is a great time to familiarize yourself with the GraphQL data in your website. Point your browser to <code class=\"language-text\">http://localhost:8000/___graphql</code> to start exploring your data, and you can build the query access and Shared Content or Sitemap data. You can see that all content is available, grouped by content definition name.</p>\n<p>Here’s the query that I used to grab a Global Header shared content item, as well as the nested sitemap as JSON.</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token keyword\">query</span> GlobalHeaderQuery <span class=\"token punctuation\">{</span>\n  agilityGlobalHeader<span class=\"token punctuation\">(</span><span class=\"token attr-name\">properties</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token attr-name\">referenceName</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token attr-name\">eq</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"globalheader\"</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    customFields <span class=\"token punctuation\">{</span>\n      marketingBanner\n      logo <span class=\"token punctuation\">{</span>\n        url\n        label\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    preHeaderLinks <span class=\"token punctuation\">{</span>\n      customFields <span class=\"token punctuation\">{</span>\n        title\n        uRL <span class=\"token punctuation\">{</span>\n          href\n          target\n          text\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  agilitynestedsitemap <span class=\"token punctuation\">{</span>\n    internal <span class=\"token punctuation\">{</span>\n      content\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Your query will look different, of course, but I hope you get the idea of how to query your Agility CMS content.</p>\n<p>Now, you can create a component that uses a <code class=\"language-text\">&lt;StaticQuery&gt;</code> to pull in the data and make it available. Check out the example <code class=\"language-text\">GlobalHeader.js</code> component in your project for an example of that.</p>\n<h2>Step 3: Create a new Home Page</h2>\n<p>In Agility CMS, the first page in your sitemap is considered your Home Page. So, I created a new home page and temporarily called it home-2. I didn’t publish it, but this meant that I could use this to build out the modules on the new home page.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/gatsby-bloga-2/static/ac1c9cc4477c822641923706f86da9f4/8c857/post-image-4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABxklEQVQoz2OwMZbS0lAxMDQy0Nc3MDBQVlGRlZWVlJQ0MjJas2bNzp07t27ZsnXr1l27du0Dgr179+/fD6T3gwGDgb6ujo6Onr6+nLy8nJycjKysvIJCRGRkTm5uYVFRXn5+SUlJeUVleUVFVXVVRWVlMZBfWlpWVpaXl8egoKAcGxu7bPnypcuWrV27dsOGDb29vcEhITGxMUAjQkJDo2JiwiMjI4AgMjIcSERFhYeHBwYHBwQFMagoqzg7uwBNApoKNBJoQ2p6ekJySm5+YU5efmZ2NtDyzKys7NzcjKysrJycnLw8IMrNzwcqY7C31FZUUtXQ1FDX0JBTUAA6W1lZ+caNa//////79+9/vIBBX1dLTU3dytLK2tpGTU1NQUHBwNBw4bxZjbWV5eVAh1SWlZdDPAkC5eUQuhSMGDS1dDQ1NM1szcwtzbW1tVXV1IyNTeYtnl/aVNbQ0FhXX9/a1tbR2dnR0dHW3g5HEMCgpaWlqaltZmVm7+IAtFxXT09P1+DYhaPXP1z5/fP3j58//v37h9PZurp6mhpa+sb6Fo4W1lY2+obAuDM4cvbw6UfHnz95/gIMnj9//uTJk48fP/5CBQBynAs8wQFqAgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Agility CMS Screenshot - temporary home page\"\n        title=\"Agility CMS Screenshot - Home Page\"\n        src=\"/gatsby-bloga-2/static/ac1c9cc4477c822641923706f86da9f4/fcda8/post-image-4.png\"\n        srcset=\"/gatsby-bloga-2/static/ac1c9cc4477c822641923706f86da9f4/12f09/post-image-4.png 148w,\n/gatsby-bloga-2/static/ac1c9cc4477c822641923706f86da9f4/e4a3f/post-image-4.png 295w,\n/gatsby-bloga-2/static/ac1c9cc4477c822641923706f86da9f4/fcda8/post-image-4.png 590w,\n/gatsby-bloga-2/static/ac1c9cc4477c822641923706f86da9f4/8c857/post-image-4.png 761w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>I created a couple of new Module Definitions that I needed for the new page design, so I created new react components in the <strong>modules</strong> folder for those. The amazing thing about the Agility CMS Gatsby implementation is that nearly all the data that you need to render a module on a page is given to you in a property called <strong>item</strong>.</p>\n<p>What I normally do is just <code class=\"language-text\">console.log(&quot;ModuleName&quot;, item)</code> so I can see exactly what that data looks like. Then run the site locally in your browser <code class=\"language-text\">http://localhost:8000</code> and open up your Developer Tools to see what it looks like in the console.</p>\n<h3>Hot Reloading - Code and Content</h3>\n<p>One of the best things about React development with Gatsby is that everything can be hot reloaded, including the content!</p>\n<p>If you leave your browser open beside your code, you can just make changes and see them. Additionally, if you open a second terminal window, you can also pull down any changes that you make to the content in Agility CMS without having to run <code class=\"language-text\">gatsby develop</code> again.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">curl</span> -X POST http://localhost:8000/__refresh</code></pre></div>\n<p>Here’s a side-by-side screenshot of my 2 monitor setup. You can see that I have 2 terminal windows opened in VS Code.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/gatsby-bloga-2/static/5ed665fb64579acbf2d6c3a07134d002/29114/post-image-5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.405405405405407%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABgUlEQVQY01WPbWvTYBSG80P8IzIQxE9+H4i/xK/7GX4TkcEQx8SZrnSbrNtkdJsgm0tfZlzStE3Spknz+jRpk8uHKIIHbs6Bc851zq2cNi/Y3/5KW/3CuXpEu3HFnTZA6+l0ewNUtcEvXWc28/C9gLnrE4chaZqyXOYIIeo6jiKiMEKxW88wP21gN55w++Y51vGruhGFCVEwpdlUsScT4iQmDXOyeUZVFPwfFVVZkaUCxTp6jHf+iMvXL9na+MzdzhYimpCJNcNem+bBPrbjSmBSL+TyWCmB5WolISVVVf1TIp9QzL1NguOn0H3Bor9Nbh/guwNCf8hi9sDhYQvDtAjDmExaLOJEwtaU5V9Q/d8fFcUK5fvZW/o3Z/S6t4yte4yJy7frE7SbUzoXLXY/7ODNXHKRsgg8vKlDlkS10XJVkMYRyyxlXeRUawnU+gbm0EE3HKyRgzmWssbYtsPPe5137z/S0Qx+GFMu5Wyn+4DuxlhBwXC+lBJYvmAU5Ixk/g0D8rGjmpovVAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"two screens side by side showing hot reloading website and the Gatsby code for it\"\n        title=\"Side-by-side Hot Module Reload\"\n        src=\"/gatsby-bloga-2/static/5ed665fb64579acbf2d6c3a07134d002/fcda8/post-image-5.png\"\n        srcset=\"/gatsby-bloga-2/static/5ed665fb64579acbf2d6c3a07134d002/12f09/post-image-5.png 148w,\n/gatsby-bloga-2/static/5ed665fb64579acbf2d6c3a07134d002/e4a3f/post-image-5.png 295w,\n/gatsby-bloga-2/static/5ed665fb64579acbf2d6c3a07134d002/fcda8/post-image-5.png 590w,\n/gatsby-bloga-2/static/5ed665fb64579acbf2d6c3a07134d002/efc66/post-image-5.png 885w,\n/gatsby-bloga-2/static/5ed665fb64579acbf2d6c3a07134d002/c83ae/post-image-5.png 1180w,\n/gatsby-bloga-2/static/5ed665fb64579acbf2d6c3a07134d002/29114/post-image-5.png 1920w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>I really love this workflow! It makes it really easy to tweak things and see the changes instantly.</p>\n<h2>Step 4: Run it in Gatsby Cloud</h2>\n<p>To get going, <a href=\"https://www.gatsbyjs.com/\">Gatsby Cloud</a> is the easiest way to Preview and Build Gatsby sites. The free version is enough to get you started.</p>\n<p>Push your code to a GitHub repo, sign up for Gatsby Cloud, and create a new site. When asked, simply choose “I already have a Gatsby site” and don’t add any integrations just now.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/gatsby-bloga-2/static/ba41941098e81273668bd62eb299cded/9c177/post-image-6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAAA5UlEQVQY022QDW+DIBCG/f+/sKuJVitfVVvdKhwfd+zYOtOmI08IBJ7jPaoEeSc6opBnszR117anaZrEIJRUfddnyu+j2jUmWESf58vycaiPx1op1TRtdyqFEPF/mWLO+MTfI/S0xoQpIs9MDOhd4m3FtwHgN57Rput6IeRwHpyDANGcF9Mvsr2O4nMUq+5vjP2CFAlsKLL3IIVkWWvNJre6risSeojehXm8ajka9WAebyFEouxdrDASJkqhhCmpEIkeWd0WnGW83cDef9gAXGDN3j2wvH916fx1cBVuLKU3YoFPvwFVuJPMaunrpQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"landing page for Gatsby Cloud Create New Site\"\n        title=\"Gatsby Cloud - Create New Site\"\n        src=\"/gatsby-bloga-2/static/ba41941098e81273668bd62eb299cded/fcda8/post-image-6.png\"\n        srcset=\"/gatsby-bloga-2/static/ba41941098e81273668bd62eb299cded/12f09/post-image-6.png 148w,\n/gatsby-bloga-2/static/ba41941098e81273668bd62eb299cded/e4a3f/post-image-6.png 295w,\n/gatsby-bloga-2/static/ba41941098e81273668bd62eb299cded/fcda8/post-image-6.png 590w,\n/gatsby-bloga-2/static/ba41941098e81273668bd62eb299cded/9c177/post-image-6.png 880w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>You can securely add your API Keys in the Environment Variable section of Settings.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/gatsby-bloga-2/static/e0076d93a7ce3477226ed1b6d4ece8b7/9c177/post-image-7.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABOUlEQVQoz31S2XKEMAzj//+yb+UIuePcrRKzDLPbqYYJCbYcS2ZxOmhhc0611pxLDClSinE+IfXW39F6yRXvUsoSAp2nDBRaa84FKYyS9hRa7EoK2/vPG0COPmMzyOTpWKXVDmScW6ttAvv+SX1gkL0N65dwxiPVWnvsx7ZuRps4+k7IyBAz1/QAV1+ISCnFZ+ecEMJ7j8IgK6n0BBKcdTcfoVobaw6IIcDkfd+RDb59gPm4JkyAdrWNkgA3NsVy0QLzSx0fb9w9I1LGaPKCwtxSbdUav32f4tDqNPuqvKVPn+A2uZfbxtht2yADl8KhFPO8dYwN8/yD3Hst7SKjDYhhw7CBBCjEinKs7b9R3XpAhk9SSniDQEoZR5QginMlHMMLw5E3MvTDbR4VvmhtGPKUWKeZF/j3/AWmkLs65g3AfwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Gatsby webpage for setting environment variables\"\n        title=\"Gatsby Cloud - Environment Variables\"\n        src=\"/gatsby-bloga-2/static/e0076d93a7ce3477226ed1b6d4ece8b7/fcda8/post-image-7.png\"\n        srcset=\"/gatsby-bloga-2/static/e0076d93a7ce3477226ed1b6d4ece8b7/12f09/post-image-7.png 148w,\n/gatsby-bloga-2/static/e0076d93a7ce3477226ed1b6d4ece8b7/e4a3f/post-image-7.png 295w,\n/gatsby-bloga-2/static/e0076d93a7ce3477226ed1b6d4ece8b7/fcda8/post-image-7.png 590w,\n/gatsby-bloga-2/static/e0076d93a7ce3477226ed1b6d4ece8b7/9c177/post-image-7.png 880w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Now you can take the Preview link from Gatsby and plug that into Agility CMS in the Domain Configuration area of the Settings section.</p>\n<p>Additionally, Gatsby gives you webhook URLs for Preview and Build. You can go ahead and plug these into the Webhook area in Agility Settings.</p>\n<h2>Step 5: Deploy to Netlify</h2>\n<p>Netlify is a really great service to easily host static websites. Even better, it integrates seamlessly so that Gatsby can automatically deploy your website to Netlify when it builds!</p>\n<p>Go ahead and create a free Netlify account and point to it under the Gatsby <strong>Hosting Integrations</strong> settings section.</p>\n<p>Since Gatsby is going to be building the LIVE version of our site, we need to publish our new Homepage in Agility. If you’ve reviewed everything in Preview and you’re ready to go, the first thing you need to do is to disable the Syncing Web Servers for the existing website in Agility CMS. You’ll have to coordinate this with your content team, of course.</p>\n<p>When I was testing all this out, I actually built my new site using the Preview API Keys temporarily. That way I could verify everything was working first.</p>\n<p>In the end, you’re going to end up with a URL to your new home page in Netlify.</p>\n<h2>Step 6: Setup the CDN to do the Edge Routing</h2>\n<p>We can use Edge computing to decide whether to route to the new website or the old one, depending on the page.</p>\n<p>In this example, I decided to use a <a href=\"https://www.stackpath.com/\">StackPath</a> Script to do this for us.</p>\n<p>You set up a StackPath site just like normal, but pointing to your OLD website’s unique hostname. It can’t be your public DNS name - you need to have another unique way to address that site. For example, since our website is hosted in an Azure App Service, we get an azurewebsites.net URL.</p>\n<p>Now you create a Script in StackPath to do the routing. In our case, we ONLY want to route requests to the home page, plus any Gatsby-specific stuff, to our new website.</p>\n<p>You can also see that I’m only allowing for 60 seconds on caching in the CDN for all requests. This is because we don’t have anything built into this workflow to clear the cache in this CDN, and I don’t want my content team to have to wait too long to see their changes. I’ll take care of that later.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// sample script</span>\n<span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fetch\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  event<span class=\"token punctuation\">.</span><span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span><span class=\"token function\">handleRequest</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * Fetch and return the request body\n * @param {Request} request\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleRequest</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">request</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Wrap your script in a try/catch and return the error stack to view error information</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* The request can be modified here before sending it with fetch */</span>\n\n    <span class=\"token keyword\">const</span> originalUrl <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>url\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// we need get the url in order to figure out where to route them</span>\n    <span class=\"token keyword\">let</span> path <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span>pathname\n\n    <span class=\"token comment\">//secondary domain...</span>\n    <span class=\"token keyword\">const</span> secDomain <span class=\"token operator\">=</span> <span class=\"token string\">\"https://my-new-website.netlify.app\"</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      path <span class=\"token operator\">==</span> <span class=\"token string\">\"/\"</span> <span class=\"token operator\">||</span> <span class=\"token comment\">//redirect the home page...</span>\n      path<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/webpack\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span>\n      path<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/common\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span>\n      path<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/component\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span>\n      path<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/page-data\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span>\n      path<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/styles\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span>\n      path<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/app-\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// we need get the url in order to figure out where to route them</span>\n      request<span class=\"token punctuation\">.</span>url <span class=\"token operator\">=</span> secDomain <span class=\"token operator\">+</span> path\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n\n    response<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cache-Control\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"public, max-age=60\"</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> response\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Response</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>stack <span class=\"token operator\">||</span> e<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> status<span class=\"token operator\">:</span> <span class=\"token number\">500</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can now test this whole thing with the unique StackPath URL that you get (123xyz.stackpathcdn.com).</p>\n<p>Once you are happy with everything, you simply switch your DNS to point to StackPath.</p>\n<p>That’s it—you’re finished!</p>\n<p>If you have any questions about JAMstack or migrating to this technology, reach out!</p>\n<h2>Next Steps</h2>\n<p>I encourage you to go ahead and use this technique as the starting point for one of the pages on your own website! You can use <a href=\"https://agilitycms.com/v3-free-signup-developers?source=devto\">Agility CMS for free</a> to do it.</p>\n<h2>BONUS CONTENT!</h2>\n<p>As a companion to this article, I recorded a video that walks you through the steps I took and the different tools involved. I also highlight some of the really neat features of Agility CMS, Gatsby, Netlify, and StackPath.</p>\n<p><a href=\"https://www.youtube.com/embed/WSIzYKDgJuE\" title=\"Migrating a website to JAMstack with Gatsby\"><img src=\"https://res.cloudinary.com/marcomontalbano/image/upload/v1586464859/video_to_markdown/images/youtube--WSIzYKDgJuE-c05b58ac6eb4c4700831b2b3070cd403.jpg\" alt=\"Migrating a website to JAMstack with Gatsby\"></a></p>","frontmatter":{"title":"Rebuilding the Agility CMS Website with Gatsby (one page at a time)","date":"April 13, 2020","description":null}}},"pageContext":{"slug":"/docs/blog/2020-04-13-upgrading-to-jamstack-with-agility/","previous":{"fields":{"slug":"/docs/blog/2020-04-10-LA-2020-Libere/"},"frontmatter":{"title":"Gatsby Days LA 2020 Video 8: Building Excitement for Gatsby in East Africa"}},"next":{"fields":{"slug":"/docs/blog/2020-04-13-LA-2020-Comeau/"},"frontmatter":{"title":"Gatsby Days LA 2020 Video 9: Empowering Content Creators with a Headless CMS and Gatsby"}}}}}