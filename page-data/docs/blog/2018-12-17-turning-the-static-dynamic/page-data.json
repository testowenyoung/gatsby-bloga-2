{"componentChunkName":"component---src-templates-blog-post-js","path":"/docs/blog/2018-12-17-turning-the-static-dynamic/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"ca10380c-4711-5907-8a4a-909e5291ba30","excerpt":"In a recent Reactiflux interview, the Gatsby team was asked this question: Q: What is one thing that Gatsby is capable of doing that might surprise some people…","html":"<p><a href=\"https://www.reactiflux.com/transcripts/gatsby-team/\">In a recent Reactiflux interview</a>, the Gatsby team was asked this question:</p>\n<blockquote>\n<p>Q: What is one thing that Gatsby is capable of doing that might surprise some people? — ctlee</p>\n</blockquote>\n<blockquote>\n<p>A: Gatsby can be used to build fully dynamic sites, which surprises some people because of it’s label as a “static site generator”. It’s fully equipped to be a powerful alternative to create-react-app and other similar solutions with the addition of easy pre-rendering and perf baked in. — biscarch</p>\n</blockquote>\n<p>Even though Dustin <a href=\"/gatsby-bloga-2/blog/2018-11-07-gatsby-for-apps/\">recently wrote about Gatsby for Apps</a> and open sourced his <a href=\"https://gatsby-mail.netlify.app/\">Gatsby Mail</a> demo, I do still find people constantly having to explain that Gatsby is “not just for sites”.</p>\n<p>Today I’d like to show you how you can incrementally add functionality to a Gatsby static site with Netlify Functions, and then add authentication with Netlify Identity to begin a proper Gatsby app.</p>\n<h2>Static-Dynamic is a spectrum</h2>\n<p>Why would you use something like Gatsby over Jekyll or Hugo or one of the <a href=\"https://www.staticgen.com/\">hundreds of Static Site Generators</a> out there? <a href=\"/gatsby-bloga-2/blog/2018-2-27-why-i-upgraded-my-website-to-gatsbyjs-from-jekyll/\">There are many reasons</a>, but one of the unique selling points is how Gatsby helps you build <a href=\"/gatsby-bloga-2/docs/progressive-web-app/#progressive-web-app\">“Static Progressive Web Apps”</a> with React.</p>\n<p><a href=\"/gatsby-bloga-2/docs/production-app/#dom-hydration\">Gatsby’s ability to rehydrate</a> (what a delicious word!) the DOM means you can do incredibly dynamic things with JavaScript and React that would be much harder with legacy SSG’s.</p>\n<p>Let’s say you have a typical static Gatsby site, like <a href=\"/gatsby-bloga-2/starters/gatsby-starter-default\">gatsby-starter-default</a>. You can <code class=\"language-text\">npm run build</code> it, and it spits out a bunch of HTML files. Great! I can host that for free!</p>\n<p>Now your client comes to you and asks you to add some custom logic that needs to be executed on the server:</p>\n<ul>\n<li>Maybe you have third party API secrets you don’t want to expose to your user.</li>\n<li>Maybe you need <a href=\"https://developer.yahoo.com/javascript/howto-proxy.html?guccounter=1\">a serverside proxy to get around CORS issues</a>.</li>\n<li>Maybe you need to ping a database to check your inventory.</li>\n</ul>\n<p><strong>Oh no! Now you have to rewrite everything and move to a Digital Ocean droplet!</strong></p>\n<p>I’m kidding. No, you don’t have to rewrite everything.</p>\n<p>The beauty of serverless functions is that it is incrementally adoptable - <strong>your site grows with your needs</strong> - and with Gatsby you can rerender entire sections of your site based on live API data. Of course, the more you do this, the more resource intensive (in terms of bandwidth and computation) it can be, so there is a performance tradeoff. <strong>Your site should be as dynamic as you need it to be, but no more.</strong> Gatsby is perfect for this.</p>\n<h2>5 Steps to add Netlify Functions to Gatsby</h2>\n<p>Netlify Functions are a great low configuration solution for adding serverless functionality to your Gatsby site. You get 125,000 free calls a month - that’s a function call every 20 seconds every day of the week, month, and year - and you can emulate them in local development with <a href=\"https://github.com/netlify/netlify-lambda\"><code class=\"language-text\">netlify-lambda</code></a>.</p>\n<p>Let’s walk through the steps:</p>\n<ol>\n<li><strong>Install dependencies</strong>: <code class=\"language-text\">npm install -D http-proxy-middleware netlify-lambda npm-run-all</code></li>\n<li><strong>Run function emulation alongside Gatsby</strong>: replace your <code class=\"language-text\">scripts</code> in <code class=\"language-text\">package.json</code>:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"develop\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"gatsby develop\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"run-p start:**\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"start:app\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"npm run develop\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"start:lambda\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"netlify-lambda serve src/functions\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"gatsby build &amp;&amp; netlify-lambda build src/functions\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"build:app\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"gatsby build\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"build:lambda\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"netlify-lambda build src/functions\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>When deploying to Netlify, <code class=\"language-text\">gatsby build</code> must be run before <code class=\"language-text\">netlify-lambda build src/functions</code> or else your Netlify function builds will fail. To avoid this, do not set your build script command to <code class=\"language-text\">&quot;build&quot;: &quot;run-p build:**&quot;</code> when you replace <code class=\"language-text\">scripts</code> in <code class=\"language-text\">package.json</code>. Doing so will run all build scripts in parallel. This will make it possible for <code class=\"language-text\">netlify-lambda build src/functions</code> to run before <code class=\"language-text\">gatsby build</code>.</p>\n<ol start=\"3\">\n<li><strong>Configure your Netlify build</strong>: When serving your site on Netlify, <code class=\"language-text\">netlify-lambda</code> will now build each JavaScript/TypeScript file in your <code class=\"language-text\">src/functions</code> folder as a standalone Netlify function (with a path corresponding to the filename). Make sure you have a Functions path in a <code class=\"language-text\">netlify.toml</code> file at root of your repository:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"toml\"><pre class=\"language-toml\"><code class=\"language-toml\"><span class=\"token punctuation\">[</span><span class=\"token table class-name\">build</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key property\">command</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"npm run build\"</span>\n  <span class=\"token key property\">functions</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"functions\"</span>\n  <span class=\"token key property\">publish</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"public\"</span></code></pre></div>\n<p>For more info or configuration options (e.g. in different branches and build environments), check <a href=\"https://docs.netlify.com/configure-builds/file-based-configuration/\">the Netlify.toml reference</a>.</p>\n<p><strong>NOTE:</strong> the <code class=\"language-text\">command</code> specified in <code class=\"language-text\">netlify.toml</code> overrides the build command specified in your site’s Netlify UI Build settings.</p>\n<ol start=\"4\">\n<li><strong>Proxy the emulated functions for local development</strong>: Head to <code class=\"language-text\">gatsby-config.js</code> and add this to your <code class=\"language-text\">module.exports</code>:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=gatsby-config.js\"><pre class=\"language-jsx:title=gatsby-config.js\"><code class=\"language-jsx:title=gatsby-config.js\">const { createProxyMiddleware } = require(&quot;http-proxy-middleware&quot;) //v1.x.x\n// Use implicit require for v0.x.x of &#39;http-proxy-middleware&#39;\n// const proxy = require(&#39;http-proxy-middleware&#39;)\n// be sure to replace &#39;createProxyMiddleware&#39; with &#39;proxy&#39; where applicable\n\nmodule.exports = {\n  // for avoiding CORS while developing Netlify Functions locally\n  // read more: https://www.gatsbyjs.org/docs/api-proxy/#advanced-proxying\n  developMiddleware: app =&gt; {\n    app.use(\n      &quot;/.netlify/functions/&quot;,\n      createProxyMiddleware({\n        target: &quot;http://localhost:9000&quot;,\n        pathRewrite: {\n          &quot;/.netlify/functions/&quot;: &quot;&quot;,\n        },\n      })\n    )\n  },\n  // ...\n}</code></pre></div>\n<ol start=\"5\">\n<li><strong>Write your functions</strong>: Make a <code class=\"language-text\">src/functions</code> folder and write as many functions as you need. The only requirement is that each function must export a <code class=\"language-text\">handler</code>, although <code class=\"language-text\">netlify-lambda</code> helps you use webpack to bundle modules or you can <a href=\"https://www.netlify.com/blog/2018/09/14/forms-and-functions/#optional-zip-the-function-to-manage-dependencies\">zip the functions yourself</a>. For example you can write <code class=\"language-text\">src/functions/hello.js</code>:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// For more info, check https://www.netlify.com/docs/functions/#javascript-lambda-functions</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"queryStringParameters\"</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">.</span>queryStringParameters<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// return null to show no errors</span>\n    statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// http status code</span>\n    body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      msg<span class=\"token operator\">:</span> <span class=\"token string\">\"Hello, World! \"</span> <span class=\"token operator\">+</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now you are ready to access this API from anywhere in your Gatsby app! For example, in any event handler or lifecycle method, insert:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/.netlify/functions/hello\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span> <span class=\"token operator\">=></span> response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>console<span class=\"token punctuation\">.</span>log<span class=\"token punctuation\">)</span></code></pre></div>\n<p>and watch “Hello World!” pop up in your console. (I added a random number as well to show the endpoint is dynamic) If you are new to React, I highly recommend <a href=\"https://reactjs.org/docs/handling-events.html\">reading through the React docs</a> to understand where and how to insert event handlers so you can, for example, <a href=\"https://reactjs.org/docs/handling-events.html\">respond to a button click</a>.</p>\n<p>The local proxying we are doing is only for local emulation, e.g. it is actually running from <code class=\"language-text\">http://localhost:9000/hello</code> despite you hitting <code class=\"language-text\">/.netlify/functions/hello</code> in your Gatsby app. When you deploy your site to Netlify (either by <a href=\"https://app.netlify.com/\">hooking your site up through Git through our Web UI</a>, or our l33t new <a href=\"https://docs.netlify.com/cli/get-started/\">CLI</a>), that falls away, and your functions -are- hosted on the same URL and “just works”. Pretty neat!</p>\n<h2>That’s cool, but its not an app</h2>\n<p>So, yes, your site can now be more dynamic than any static site. It can hit any database or API. It runs rings around CORS (by the way, you can also use <a href=\"https://docs.netlify.com/routing/redirects/\">Netlify Redirects</a> for that). But its not an <em>app</em> app. Yet!</p>\n<p>The key thing about web apps (and, let’s face it, the key thing users really pay for) is they all have some concept of <code class=\"language-text\">user</code>, and that brings with it all manner of complication from security to state management to <a href=\"https://docs.netlify.com/visitor-access/role-based-access-control/\">role-based access control</a>. Entire routes need to be guarded by authentication, and sensitive content shielded from Gatsby’s static generation. Sometimes there are things you -don’t- want Google’s spiders to see!</p>\n<p>It’s a different tier of concern, which makes it hard to write about in the same article as a typical Gatsby tutorial. But we’re here to make apps, so let’s bring it on!</p>\n<h2>5 Steps to add Netlify Identity and Authenticated Pages to Gatsby</h2>\n<ol>\n<li><strong>Enable Netlify Identity</strong>: Netlify Identity doesn’t come enabled by default. You’ll have to head to your site admin (e.g. <code class=\"language-text\">https://app.netlify.com/sites/YOUR_AWESOME_SITE/identity</code>) to turn it on. <a href=\"https://docs.netlify.com/visitor-access/identity/\">Read the docs</a> for further info on what you can do, for example add Facebook or Google social sign-on!</li>\n<li><strong>Install dependencies</strong>: <code class=\"language-text\">npm install netlify-identity-widget gatsby-plugin-create-client-paths</code></li>\n<li><strong>Configure Gatsby</strong>: for dynamic-ness!</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"js:title=gatsby-config.js\"><pre class=\"language-js:title=gatsby-config.js\"><code class=\"language-js:title=gatsby-config.js\">module.exports = {\n  plugins: [\n    {\n      resolve: `gatsby-plugin-create-client-paths`,\n      options: { prefixes: [`/app/*`] },\n    },\n    // ...\n  ],\n  // ... (including what you also wrote earlier)\n}</code></pre></div>\n<ol start=\"4\">\n<li><strong>Write an authentication service</strong>: <code class=\"language-text\">netlify-identity-widget</code> is a framework-agnostic overlay that ships with a nice signup/login UI. This gets you up and running the fastest, however if you need a smaller solution you may want to use the underlying <a href=\"https://github.com/netlify/gotrue-js\">gotrue-js</a>, or <a href=\"https://github.com/sw-yx/react-netlify-identity\">react-netlify-identity</a> for a React Hooks solution.</li>\n</ol>\n<p>Here’s a usable example that stores your user in local storage:</p>\n<div class=\"gatsby-highlight\" data-language=\"js:title=service/auth.js\"><pre class=\"language-js:title=service/auth.js\"><code class=\"language-js:title=service/auth.js\">import netlifyIdentity from &quot;netlify-identity-widget&quot;\n\nexport const isBrowser = () =&gt; typeof window !== &quot;undefined&quot;\nexport const initAuth = () =&gt; {\n  if (isBrowser()) {\n    window.netlifyIdentity = netlifyIdentity\n    // You must run this once before trying to interact with the widget\n    netlifyIdentity.init()\n  }\n}\nexport const getUser = () =&gt;\n  isBrowser() &amp;&amp; window.localStorage.getItem(&quot;netlifyUser&quot;)\n    ? JSON.parse(window.localStorage.getItem(&quot;netlifyUser&quot;))\n    : {}\n\nconst setUser = user =&gt;\n  window.localStorage.setItem(&quot;netlifyUser&quot;, JSON.stringify(user))\n\nexport const handleLogin = callback =&gt; {\n  if (isLoggedIn()) {\n    callback(getUser())\n  } else {\n    netlifyIdentity.open()\n    netlifyIdentity.on(&quot;login&quot;, user =&gt; {\n      setUser(user)\n      callback(user)\n    })\n  }\n}\n\nexport const isLoggedIn = () =&gt; {\n  if (!isBrowser()) return false\n  const user = netlifyIdentity.currentUser()\n  return !!user\n}\n\nexport const logout = callback =&gt; {\n  netlifyIdentity.logout()\n  netlifyIdentity.on(&quot;logout&quot;, () =&gt; {\n    setUser({})\n    callback()\n  })\n}</code></pre></div>\n<ol start=\"5\">\n<li><strong>Write your app</strong>: Now, any sub paths in <code class=\"language-text\">src/pages/app</code> will be exempt from Gatsby static generation. To keep the dividing line between app and site crystal clear, I like to have all my dynamic Gatsby code in a dedicated <code class=\"language-text\">app</code> folder. This means you can use <code class=\"language-text\">@reach/router</code> with <code class=\"language-text\">netlify-identity-widget</code> to write a standard dynamic React app. Here’s some sample code to give you an idea of how to hook them up:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=app.js\"><pre class=\"language-jsx:title=app.js\"><code class=\"language-jsx:title=app.js\">import React from &quot;react&quot;\nimport { Router } from &quot;@reach/router&quot; // comes with gatsby v2\nimport Layout from &quot;../components/layout&quot;\nimport NavBar from &quot;./components/NavBar&quot;\nimport Profile from &quot;./profile&quot;\nimport Main from &quot;./main&quot; // NOT SHOWN\nimport PrivateRoute from &quot;./components/PrivateRoute&quot;\nimport Login from &quot;./login&quot;\n\n// remember everything in /app/* is dynamic now!\nconst App = () =&gt; {\n  return (\n    &lt;Layout&gt;\n      &lt;NavBar /&gt;\n      &lt;Router&gt;\n        &lt;PrivateRoute path=&quot;/app/profile&quot; component={Profile} /&gt;\n        &lt;PublicRoute path=&quot;/app&quot;&gt;\n          &lt;PrivateRoute path=&quot;/&quot; component={Main} /&gt;\n          &lt;Login path=&quot;/login&quot; /&gt;\n        &lt;/PublicRoute&gt;\n      &lt;/Router&gt;\n    &lt;/Layout&gt;\n  )\n}\nfunction PublicRoute(props) {\n  return &lt;div&gt;{props.children}&lt;/div&gt;\n}\n\nexport default App</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=components/navbar.js\"><pre class=\"language-jsx:title=components/navbar.js\"><code class=\"language-jsx:title=components/navbar.js\">import React from &quot;react&quot;\nimport { Link, navigate } from &quot;gatsby&quot;\nimport { getUser, isLoggedIn, logout } from &quot;../services/auth&quot;\n\nexport default function NavBar() {\n  const content = { message: &quot;&quot;, login: true }\n  const user = getUser()\n  if (isLoggedIn()) {\n    content.message = `Hello, ${\n      user.user_metadata &amp;&amp; user.user_metadata.full_name\n    }`\n  } else {\n    content.message = &quot;You are not logged in&quot;\n  }\n  return (\n    &lt;div\n      style={{\n        display: &quot;flex&quot;,\n        flex: &quot;1&quot;,\n        justifyContent: &quot;space-between&quot;,\n        borderBottom: &quot;1px solid #d1c1e0&quot;,\n        backgroundColor: &quot;aliceblue&quot;,\n      }}\n    &gt;\n      &lt;span&gt;{content.message}&lt;/span&gt;\n\n      &lt;nav&gt;\n        &lt;span&gt;Navigate the app: &lt;/span&gt;\n        &lt;Link to=&quot;/app/&quot;&gt;Main&lt;/Link&gt;\n        {` `}\n        &lt;Link to=&quot;/app/profile&quot;&gt;Profile&lt;/Link&gt;\n        {` `}\n        {isLoggedIn() ? (\n          &lt;a\n            href=&quot;/&quot;\n            onClick={event =&gt; {\n              event.preventDefault()\n              logout(() =&gt; navigate(`/app/login`))\n            }}\n          &gt;\n            Logout\n          &lt;/a&gt;\n        ) : (\n          &lt;Link to=&quot;/app/login&quot;&gt;Login&lt;/Link&gt;\n        )}\n      &lt;/nav&gt;\n    &lt;/div&gt;\n  )\n}</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=components/privateroute.js\"><pre class=\"language-jsx:title=components/privateroute.js\"><code class=\"language-jsx:title=components/privateroute.js\">import React from &quot;react&quot;\nimport { isLoggedIn } from &quot;../services/auth&quot;\nimport { navigate } from &quot;gatsby&quot;\n\nclass PrivateRoute extends React.Component {\n  componentDidMount = () =&gt; {\n    const { location } = this.props\n    if (!isLoggedIn() &amp;&amp; location.pathname !== `/app/login`) {\n      // If the user is not logged in, redirect to the login page.\n      navigate(`/app/login`)\n      return null\n    }\n  }\n\n  render() {\n    const { component: Component, location, ...rest } = this.props\n    return isLoggedIn() ? &lt;Component {...rest} /&gt; : null\n  }\n}\n\nexport default PrivateRoute</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=login.js\"><pre class=\"language-jsx:title=login.js\"><code class=\"language-jsx:title=login.js\">import React from &quot;react&quot;\nimport { navigate } from &quot;gatsby&quot;\nimport { handleLogin, isLoggedIn } from &quot;./services/auth&quot;\n\nclass Login extends React.Component {\n  handleSubmit = () =&gt; handleLogin(user =&gt; navigate(`/app/profile`))\n  render() {\n    return (\n      &lt;&gt;\n        &lt;h1&gt;Log in&lt;/h1&gt;\n        &lt;button onClick={this.handleSubmit}&gt;log in&lt;/button&gt;\n      &lt;/&gt;\n    )\n  }\n}\n\nexport default Login</code></pre></div>\n<p>Phew that was a lot! but you should have a solid starting point for your app :)</p>\n<h2>Bonus points: Authenticated Lambda Functions for your Gatsby App</h2>\n<p>Just like <a href=\"https://en.wikipedia.org/wiki/The_Prestige_(film)\">every magic act has a pledge, a turn, and a prestige</a>, I have one last tidbit for you. <a href=\"https://stackoverflow.com/questions/50277192/react-security-concerns-restricted-pages-in-app\">Nothing on the client-side is safe</a>, and although you can send along Netlify Identity user id’s to your Netlify Function endpoints for authenticated access from your Gatsby App (for example in the body of a POST request), you’ll never be truly sure if that flow is secure either from malicious users or snooping.</p>\n<p>The best way to do authenticated actions inside serverless functions is to do it from inside the context of the function itself. Fortunately, <a href=\"https://docs.netlify.com/functions/functions-and-identity/\">Netlify Identity and Functions work seamlessly together</a>. All you have to do is to send along the user’s <a href=\"https://jwt.io/\">JWT</a> when hitting your endpoint:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// in your gatsby app</span>\n<span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> <span class=\"token function\">getUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/.netlify/functions/auth-hello\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    Accept<span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"Content-Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span>\n    Authorization<span class=\"token operator\">:</span> <span class=\"token string\">\"Bearer \"</span> <span class=\"token operator\">+</span> user<span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">.</span>access_token<span class=\"token punctuation\">,</span> <span class=\"token comment\">// like this</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token comment\">/* etc */</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>And then inside a Lambda function, you can now access the <code class=\"language-text\">user</code> object:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// more info: https://www.netlify.com/docs/functions/#identity-and-functions</span>\n\n<span class=\"token comment\">// Note that `netlify-lambda` only locally emulates Netlify Functions, while `netlify-identity-widget` interacts with a real Netlify Identity instance. This means that `netlify-lambda` doesn't support Netlify Functions + Netlify Identity integration.</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>clientContext<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n      user<span class=\"token punctuation\">,</span> <span class=\"token comment\">// actual user info you can use for your serverless functions</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>clientContext\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n      body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        msg<span class=\"token operator\">:</span> <span class=\"token string\">\"auth-hello: \"</span> <span class=\"token operator\">+</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        user<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n    Note that netlify-lambda only locally emulates Netlify Functions,\n    while netlify-identity-widget interacts with a real Netlify Identity instance.\n    This means that netlify-lambda doesn't support Netlify Functions + Netlify Identity integration.\n    </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n      body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        msg<span class=\"token operator\">:</span>\n          <span class=\"token string\">\"auth-hello - no authentication detected. Note that netlify-lambda doesn't locally emulate Netlify Identity.\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Gatsby - Perfect for your next Hackathon</h2>\n<p>It’s 5 steps each to turn your static Gatsby sites into dynamic, authenticated, fully serverless apps with Netlify’s free tools. This makes Gatsby a perfect tool for your next app. If you’re at a hackathon, short on time, or just like to see a full working demo, check any of the following links.</p>\n<ul>\n<li><strong>Code:</strong> <a href=\"https://github.com/sw-yx/jamstack-hackathon-starter\">https://github.com/sw-yx/jamstack-hackathon-starter</a></li>\n<li><strong>Starter:</strong> <a href=\"https://www.gatsbyjs.org/starters/jamstack-hackathon-starter\">https://www.gatsbyjs.org/starters/jamstack-hackathon-starter</a></li>\n<li><strong>Live Demo:</strong> <a href=\"https://jamstack-hackathon-starter.netlify.app/\">https://jamstack-hackathon-starter.netlify.app/</a></li>\n</ul>","frontmatter":{"title":"Turning the Static Dynamic: Gatsby + Netlify Functions + Netlify Identity","date":"December 26, 2018","description":null}}},"pageContext":{"slug":"/docs/blog/2018-12-17-turning-the-static-dynamic/","previous":{"fields":{"slug":"/docs/blog/2018-11-03-building-an-accessible-lightbox/"},"frontmatter":{"title":"Building a custom, accessible image lightbox"}},"next":{"fields":{"slug":"/docs/blog/2018-12-04-per-link-gatsby-page-transitions-with-transitionlink/"},"frontmatter":{"title":"Per-Link Gatsby page transitions with TransitionLink"}}}}}