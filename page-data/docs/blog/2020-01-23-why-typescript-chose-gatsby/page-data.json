{"componentChunkName":"component---src-templates-blog-post-js","path":"/docs/blog/2020-01-23-why-typescript-chose-gatsby/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"8e70171c-cb96-50f0-a9f7-6b4e7236cbdc","excerpt":"Why are we using Gatsby for TypeScript’s new Website? The TypeScript v1 site is a Jekyll website, and Jekyll packs a lot of power into a small tool. Jekyll is…","html":"<h2>Why are we using Gatsby for TypeScript’s new Website?</h2>\n<p>The TypeScript v1 site is a <a href=\"https://jekyllrb.com/\">Jekyll</a> website, and Jekyll packs a lot of power into a small tool. Jekyll is really great way to build static websites, but it’s built to work for small-medium sized websites of around 1-20 pages.</p>\n<p>You can feel the scope by how they treat templating (<a href=\"https://shopify.github.io/liquid/\">liquid</a>, which is a sandbox’d logic-less templating engine), how they treat the data modelling for your site (there are only really two data types: <a href=\"https://jekyllrb.com/docs/posts/\">Posts</a> &#x26; <a href=\"https://jekyllrb.com/docs/pages/\">Pages</a>) and how the tool is set up to work better with a specific folder structure.</p>\n<p>At <a href=\"https://artsy.github.io\">Artsy</a>, where I worked at before TypeScript, we had started to hit the limits of <a href=\"https://artsy.github.io/blog/2019/01/30/why-we-run-our-blog/\">working within Jekyll</a> at around 200 blog posts and a lot of custom pages. It was taking a long time to see any changes live, and the way in which we built new features into the site tended to multiply the build times. We took some time to explore different tools to use as a writing environment for our blog. In the process I looked deeply into Gatsby, and concluded that it was the right abstraction for building static sites.</p>\n<p>A few months later, I joined the TypeScript team and one of my goals was to provide better foundations for our documentation and reference tools. Right now, the TypeScript v1 website is about 60 pages, but if it was going to expand to handle internationalization (a multiplier on pages) and support all the wild ideas I have to make TypeScript easier to learn, we would need an abstraction aimed at handling larger sites but it had to stay statically deployed.</p>\n<p>It would also help to have a tool where we can use TypeScript. Our v1 website is currently a Ruby project wrapped by some JavaScript script files and Gulp. Consolidating that on JavaScript everywhere would be a good win.</p>\n<h3>What Makes Gatsby Unique</h3>\n<p>When I was evaluating static site generators, what makes Gatsby stand out is this one idea which adds an extra step to the build process. In a normal static site generator, you would more or less directly map files to their output:</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> files <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">getDirSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> htmlFiles <span class=\"token operator\">=</span> files<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>makePage<span class=\"token punctuation\">)</span>\nhtmlFiles<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">html</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> html<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Gatsby on the other hand does something a bit more like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">setupData</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> files <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">getDirSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> files<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>makePage<span class=\"token punctuation\">)</span>\n  graphQLServer<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createSite</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> pages <span class=\"token operator\">=</span> graphQLServer<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{  pages { title, text } }\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> htmls <span class=\"token operator\">=</span> pages<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>renderComponent<span class=\"token punctuation\">)</span>\n  htmls<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">html</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> html<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">setupData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">createSite</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Gatsby adds a GraphQL API which sits in-between the setup of the data and the generation of files in your static site. This abstraction provides a very strong separation of “setting up the site” vs “representation on the file system” which provides more places to introspect what is going on internally.</p>\n<p>What does this look like in practice? The server-side generation starts at <a href=\"https://github.com/microsoft/TypeScript-Website/blob/0afd526969d98c321787ab1962f72f9361ab54bd/packages/typescriptlang-org/gatsby-node.js\"><code class=\"language-text\">gatsby-node.js</code></a> but an interesting example is how a TSConfig Reference page is set up:</p>\n<ul>\n<li>In the Gatsby config file, <a href=\"https://github.com/microsoft/TypeScript-Website/blob/0afd526969d98c321787ab1962f72f9361ab54bd/packages/typescriptlang-org/gatsby-config.js#L52-L58\">we request a plugin</a> to look for markdown files in a particular folder and to mark them as <code class=\"language-text\">tsconfig-reference</code>.</li>\n<li>Then in <code class=\"language-text\">onCreatePages</code> in <code class=\"language-text\">gatsby-node.js</code> we make a <a href=\"https://github.com/microsoft/TypeScript-Website/blob/0afd526969d98c321787ab1962f72f9361ab54bd/packages/typescriptlang-org/lib/bootup/ingestion/createTSConfigReference.ts#L12-L26\">GraphQL query to get all these files</a> via the name <code class=\"language-text\">&quot;tsconfig-reference&quot;</code>.\nThese files are then used to create Pages inside Gatsby (e.g. <code class=\"language-text\">en.md</code> => <code class=\"language-text\">/en/tsconfig</code>, <code class=\"language-text\">pt.md</code> => <code class=\"language-text\">/pt/tsconfig</code>) and we link the React component used to render them.</li>\n<li>Once all of the pages are set up, Gatsby runs through each page.</li>\n<li>For the TSConfig it would load <a href=\"https://github.com/microsoft/TypeScript-Website/blob/0afd526969d98c321787ab1962f72f9361ab54bd/packages/typescriptlang-org/src/templates/tsconfigReference.tsx\">this template</a>, run <a href=\"https://github.com/microsoft/TypeScript-Website/blob/0afd526969d98c321787ab1962f72f9361ab54bd/packages/typescriptlang-org/src/templates/tsconfigReference.tsx#L94-L120\">this query</a>,and pass the results as the initial argument to <a href=\"https://github.com/microsoft/TypeScript-Website/blob/0afd526969d98c321787ab1962f72f9361ab54bd/packages/typescriptlang-org/src/templates/tsconfigReference.tsx#L9\">this function</a> - it does this per language.</li>\n</ul>\n<p>It’s a few more steps then <code class=\"language-text\">mv ../tsconfig/en.html en/tsconfig.html</code> - yep, but once you grok the larger idea, then each step is a well composed, isolated and easily tested part of a larger system. That’s what makes Gatsby a great abstraction.</p>\n<h3>Types For Tools</h3>\n<p>The TypeScript support in Gatsby is good, and improving as they start to port their own codebase to TypeScript. When I first started, I shipped <a href=\"https://github.com/gatsbyjs/gatsby/pull/13619\">a few <code class=\"language-text\">d.ts</code></a> file improvements and welcome any pings from their team with questions when it changes. In the last 2-3 months, I’ve been running in a fully typed codebase which has been a breeze.</p>\n<p>If you’re familiar with React, and clicked through into the <a href=\"https://github.com/microsoft/TypeScript-Website/blob/0afd526969d98c321787ab1962f72f9361ab54bd/packages/typescriptlang-org/src/templates/tsconfigReference.tsx#L9\">TSConfig Template</a> - you might have been a bit surprised by the somewhat unorthodox usage of React.</p>\n<p>I’m using React as a templating language, and not as a reactive UI framework. The site never uses a <code class=\"language-text\">setState</code>-like API in React. Effectively meaning that React runs once when the site is generated, and then never used again.</p>\n<p>My goal is that the TypeScript v2 website can be understood with the least amount of abstractions possible. It should not be too surprising, but vast majority of the TypeScript compiler team have a compiler background, and don’t really do web development. To ensure that they can contribute, and understand the codebase I’m aiming to use Gatsby and React to get as close to vanilla HTML + CSS + TypeScript (heh) as possible.</p>\n<p>One way to do that, is to separate the generation of HTML + CSS from any additional JavaScript which happens at runtime. This means almost every component in the site conforms to this general pattern:</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// JS imports</span>\n<span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> useEffect <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"react\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Layout <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"../components/layout\"</span>\n\n<span class=\"token comment\">// Style</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"./tsconfig.scss\"</span>\n\n<span class=\"token comment\">// The main React component</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">TSConfigReferenceTemplateComponent</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">props<span class=\"token operator\">:</span> PropTypes</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// code which happens when the page has finished loading</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// creation of static HTML via React + JSX</span>\n  <span class=\"token keyword\">const</span> post <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>markdownRemark\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>Layout locale<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>pageContext<span class=\"token punctuation\">.</span>locale<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">\"tsconfig\"</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>div id<span class=\"token operator\">=</span><span class=\"token string\">\"full-option-list\"</span> className<span class=\"token operator\">=</span><span class=\"token string\">\"indent\"</span><span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span>TSConfig Reference<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n\n        <span class=\"token operator\">&lt;</span>nav id<span class=\"token operator\">=</span><span class=\"token string\">\"sticky\"</span><span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>ul<span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>li<span class=\"token operator\">></span><span class=\"token operator\">...</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ul<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>nav<span class=\"token operator\">></span>\n\n        <span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">\"indent\"</span><span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>div dangerouslySetInnerHTML<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> __html<span class=\"token operator\">:</span> post<span class=\"token punctuation\">.</span>html<span class=\"token operator\">!</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Layout<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> TSConfigReferenceTemplateComponent\n\n<span class=\"token comment\">// The optional GraphQL query to get info for that page</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> pageQuery <span class=\"token operator\">=</span> graphql<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  query TSConfigReferenceTemplate($path: String, $tsconfigMDPath: String!) {\n    sitePage(path: { eq: $path }) {\n      id\n    }\n    markdownRemark(fileAbsolutePath: { eq: $tsconfigMDPath }) {\n      html\n    }\n  }\n</span><span class=\"token template-punctuation string\">`</span></span></code></pre></div>\n<p>I like this, because the rest of the team don’t need to <em>learn</em> React - just JSX which acts as a proxy for HTML.</p>\n<p>In the meanwhile, anyone working on the code stills get the advantages in tooling, because all of this is supported by the TypeScript compiler:</p>\n<ul>\n<li>I can still make custom React components like <code class=\"language-text\">Layout</code> above to encapsulate complexity,and TypeScript still has the props verified</li>\n<li>JSX support with TypeScript is dreamy, and I love it</li>\n<li>The ‘runtime’ code inside <code class=\"language-text\">useEffect</code> will be transpiled and verified to be correct by TypeScript</li>\n<li>The ‘runtime’ code can re-use the same libraries as the server-side rendering, but have strong guarantees about only being optionally available</li>\n</ul>\n<p>By not using any of the React <code class=\"language-text\">setState</code>-ish APIs, I can guarantee there is no “runtime” React rendering happening on a user’s browser either. This means the HTML in the built file is exactly what someone will see whether they have JavaScript enabled or not. One advantage of this, has been that I can reliably run <a href=\"https://garris.github.io/BackstopJS/\"><code class=\"language-text\">BackstopJS</code></a> to take screenshots of these static files to keep track of visual regressions as the site grows and others start to contribute.</p>\n<p>Would I recommend this constraint to people making Gatsby websites? Probably not - it’s going against the grain (React is a really good tool) of how you’re expected to use Gatsby. But the trade-off is worth it for me, and it lowers the barrier if a compiler engineer wants to contribute.</p>\n<h3>Speed</h3>\n<p>I’m blown away by how fast Gatsby is for a user.</p>\n<p>The founder of Gatsby, Kyle Mathews <a href=\"https://youtu.be/Gtd-Ht-D0sg?t=961\">gave a great talk in 2017 on the ways in which Gatsby is fast</a> and <a href=\"https://www.youtube.com/watch?v=HQEotVfTXwk\">here more recently</a>, in rough:</p>\n<ul>\n<li>Pre-fetching of related links</li>\n<li>Clever splitting of code</li>\n<li>Shrinking of assets</li>\n<li>Offline support</li>\n<li>Native lazy loading</li>\n</ul>\n<p>His long term vision is to think of Gatsby as a compiler which takes a set of input source files, and will keep trying to make a static output which is faster and faster for users. Another great resource for understanding the mechanics about why Gatsby is fast is this talk by <a href=\"https://www.youtube.com/watch?v=p14g-Sep7HY\">Nicolas Goutay at GOTO 2019</a>.</p>\n<h3>Ecosystem Wins</h3>\n<p>Gatsby has a massive community, and a lot of the time I’m able to just re-use someone else’s work. The TypeScript team only has a few <a href=\"https://github.com/microsoft/TypeScript-Website/blob/v2/packages/gatsby-remark-shiki/README.md\">unique</a> <a href=\"https://github.com/microsoft/TypeScript-Website/tree/v2/packages/typescript-vfs\">needs</a> in <a href=\"http://www.typescriptlang.org/v2/dev/twoslash/\">our code samples</a> but other than that, it’s a pretty vanilla website.</p>\n<p>It’s been great to just add a single line into the <a href=\"https://github.com/microsoft/TypeScript-Website/blob/v2/packages/typescriptlang-org/gatsby-config.js\"><code class=\"language-text\">gatsby-config.js</code></a>, run <code class=\"language-text\">yarn add gatsby-plugin-something</code> and suddenly a whole new set of features are set up. Plugins tend to be small and easy to audit, I’ve used a few.</p>\n<h3>TypeScript Support</h3>\n<p>While not “out-of-the-box”, with a little elbow grease (as of early 2020) to get comprehensive TypeScript support:</p>\n<ul>\n<li>Add <a href=\"https://www.npmjs.com/package/ts-node\"><code class=\"language-text\">ts-node</code></a> to your <code class=\"language-text\">devDependencies</code>, and create a <a href=\"https://github.com/microsoft/TypeScript-Website/blob/0afd526969d98c321787ab1962f72f9361ab54bd/packages/typescriptlang-org/tsconfig.json\"><code class=\"language-text\">tsconfig.json</code></a> in the root of your site</li>\n<li>Add set up the plugin <a href=\"https://github.com/gatsbyjs/gatsby/tree/master/packages/gatsby-plugin-typescript\"><code class=\"language-text\">gatsby-plugin-typescript</code></a></li>\n<li>\n<p>At the top of both <code class=\"language-text\">gatsby-config.js</code> and <code class=\"language-text\">gatsby-node.js</code> add:</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ts-node\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> files<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>From these files, you can import <code class=\"language-text\">.ts</code> or .<code class=\"language-text\">tsx</code> files.</p>\n</li>\n<li>To generate types for your GraphQL queries, use the plugin <a href=\"https://www.npmjs.com/package/gatsby-plugin-codegen\">gatsby-plugin-codegen</a> (I <a href=\"https://github.com/microsoft/TypeScript-website/blob/0df8f249d812acb37541c9f0aa39f4c35dafe8b6/packages/typescriptlang-org/.gitignore#L71-L74\"><code class=\"language-text\">.gitignore</code>d</a> some of its output)</li>\n</ul>\n<p>If you’re not gonna go all-in on TypeScript, (which is totally reasonable!) you can get a lot of tooling wins in VS Code by using JSDoc to annotate functions in your <code class=\"language-text\">gatsby-node.js</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">/** @type { import(\"gatsby\").GatsbyNode[\"createPages\"] } */</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createPages</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args<span class=\"token punctuation\">,</span> _opts</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  args<span class=\"token punctuation\">.</span> <span class=\"token comment\">// You'll get auto-complete on args now</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>export<span class=\"token punctuation\">.</span>createPages <span class=\"token operator\">=</span> createPages</code></pre></div>\n<p>Follow <a href=\"https://github.com/gatsbyjs/gatsby/issues/18983\">this issue</a> if you want to stay on top of the best way to use TypeScript with Gatsby.</p>\n<p>With that plug sorted, I just want to say thanks to the Gatsby team and everyone improving the gatsby ecosystem for providing a solid way to build really fast websites! You make all our lives a little bit better.</p>","frontmatter":{"title":"Why the TypeScript team is using Gatsby for its new website","date":"January 23, 2020","description":null}}},"pageContext":{"slug":"/docs/blog/2020-01-23-why-typescript-chose-gatsby/","previous":{"fields":{"slug":"/docs/blog/100days/react-component/"},"frontmatter":{"title":"Challenge 4 - Add Third-Party React Components to Your Gatsby Site"}},"next":{"fields":{"slug":"/docs/blog/2020-01-27-announcing-gatsby-builds-and-reports/"},"frontmatter":{"title":"Announcing Gatsby Builds and Reports"}}}}}