{"componentChunkName":"component---src-templates-blog-post-js","path":"/docs/blog/2019-08-30-speed-up-your-time-to-interactive-by-delaying-third-party-scripts/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"90e42a20-e112-50ac-ba57-b6bcfb4297f0","excerpt":"Gatsby does many things to get a website visible as fast as possible. But getting a website visible isn‚Äôt the only interesting metric. There are others that, if‚Ä¶","html":"<p>Gatsby does many things to get a website visible as fast as possible. But getting a website visible isn‚Äôt the only interesting metric. There are others that, if you‚Äôre not careful, can easily take much longer than needed. Even if your site still feels fast.</p>\n<p>The metric this article focuses on is ‚Äù<a href=\"https://developers.google.com/web/tools/lighthouse/audits/time-to-interactive\">Time to interactive</a>‚Äù, which is the time it takes for all your initial scripts to run. This one is particularly interesting for a couple of reasons:</p>\n<ul>\n<li>It‚Äôs not super noticeable when you use a website on desktop</li>\n<li>Scripts loaded asynchronously are counted towards this number (even though they‚Äôre async, they‚Äôre still loaded in sequence after a page load)</li>\n<li>It‚Äôs a very important part of <a href=\"https://github.com/GoogleChrome/lighthouse/blob/master/docs/scoring.md\">Google‚Äôs performance ranking</a>. Because of the user impact, it‚Äôs 5 times more important than the ‚Äù<a href=\"https://developers.google.com/web/tools/lighthouse/audits/first-meaningful-paint\">first meaningful paint</a>‚Äù, e.g. when something shows up on the screen. <strong>5 times!</strong></li>\n</ul>\n<p>These together might mean that you have a website that <em>feels</em> fast under some circumstances, but Google will give you a penalty because it‚Äôs slow.</p>\n<p>To get an overview of how your site scores, you can use Lighthouse, either in your Chrome developer tools by going to the ‚ÄúAudits‚Äù tab, or by going to <a href=\"https://web.dev/measure\">web.dev</a>. Lighthouse will test your site on a number of different metrics, such as accessibility, SEO (Search Engine Optimization), and best practices, but the one we‚Äôre interested in is ‚Äúperformance‚Äù.</p>\n<h2>The performance metric</h2>\n<p>While the other metrics are also important, the scope of this article is on performance. By default, a Gatsby site will easily get a score in the 90s (out of 100), but this can quickly become lower as you add more scripts to the page, especially third party scripts.</p>\n<p>Harry from <a href=\"https://marketingexamples.com/\">marketingexamples.com</a> linked me to a recent post of his on <a href=\"https://marketingexamples.com/seo/performance\">SEO performance</a> that mentioned the ‚ÄúTime to interactive‚Äù scoring and I decided to take another look at my website for <a href=\"https://polypane.rocks\">Polypane</a>. I had checked it in the past and it had a good (90+) score, but I was pretty shocked when it came back and suddenly had a score of 63!</p>\n<p>When looking at the performance data, the site‚Äôs first meaningful paint took slightly over a second, but the time to interactive was <em>eleven seconds</em>. Yikes!</p>\n<p>The reason for this was that I recently switched to <a href=\"https://segment.com\">Segment</a> (using <a href=\"/gatsby-bloga-2/packages/gatsby-plugin-segment-js/\">gatsby-plugin-segment-js</a>) and was loading other scripts through that, like support chat and analytics. These scripts all counted towards my ‚Äútime to interactive‚Äù.</p>\n<p>The SEO performance post included a tip from Dave of <a href=\"https://www.todesktop.com/\">ToDesktop</a> who has similar problems. His tip: Prevent loading the scripts until after a user has scrolled, along with some timeout to prevent <a href=\"http://jankfree.org/\">scroll jank</a>.</p>\n<p>By adding a timeout, your ‚ÄúTime to interactive‚Äù won‚Äôt take these scripts into account. The user won‚Äôt need your support widget in the first second of a page anyway, so this works well for everyone.. With any upside, there is always a downside: your <a href=\"https://support.google.com/analytics/answer/1009409?hl=en\">bounce rate</a> will become less accurate as the people that open your site, don‚Äôt scroll and leave will never show up in your analytics.</p>\n<p>Wanting to improve the performance rating of my own site, I forked the <a href=\"https://github.com/Kilian/gatsby-plugin-segment-js\">gatsby-plugin-segment-js</a> repository and set to work.</p>\n<h2>Updating gatsby-plugin-segment-js</h2>\n<p>The way this solution works is as follows:</p>\n<ul>\n<li>Wait for the user to scroll</li>\n<li>Do a setTimeout for 1 second</li>\n<li>Wrap the call in a <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback\">requestIdleCallback</a>, if available</li>\n<li>Then load the script</li>\n</ul>\n<p>Adding the scroll timeout as mentioned in the Marketing examples blog post was quickly done. In Gatsby however, all subsequent pages are loaded without a page refresh. This meant that potentially, people could click through your site, never scroll, and the plugin would never get loaded. To make the technique work for Gatsby, the script also needed to load onRouteChange.</p>\n<p>This led to an interesting set of requirements:</p>\n<ul>\n<li>The scripts should load only once</li>\n<li>They should load either after a scroll action, or after a page update</li>\n<li>To prevent jank there is a time delay before the load actually happens</li>\n</ul>\n<p>Due to this time delay, it could happen that you load a new page, the countdown starts, and during this countdown, you also scroll. At that point in time, the scripts haven‚Äôt loaded yet so the scroll event listener would <em>also</em> trigger a new load.</p>\n<p>To work around this, I added two locks to the Gatsby plugin:</p>\n<ul>\n<li><code class=\"language-text\">segmentSnippetLoaded</code>, <code class=\"language-text\">false</code> by default and set to <code class=\"language-text\">true</code> after it‚Äôs loaded.</li>\n<li><code class=\"language-text\">segmentSnippetLoading</code>, <code class=\"language-text\">true</code> only between when the load function has been called and when it has finished.</li>\n</ul>\n<p>Then, either on <code class=\"language-text\">scroll</code> or <code class=\"language-text\">onRouteChange</code>, we only call the load function if <code class=\"language-text\">segmentSnippetLoaded</code> is not true, and in the load function, we only continue if <code class=\"language-text\">segmentSnippetLoading</code> is not true. This prevents the function from being called at all after the first time the script has been loaded. If the function is called twice but we‚Äôre still in the countdown time, nothing happens.</p>\n<p>After implementing this on my own website, my performance score shot back up from 63 to 94 and I had an over 60% decrease in the time to interactive. Pretty good for a few lines of code.</p>\n<p>There is currently a <a href=\"https://github.com/benjaminhoffman/gatsby-plugin-segment-js/pull/19\">PR</a> open to add a <code class=\"language-text\">delayLoad</code> option to gatsby-plugin-segment-js to enable this feature. Alternatively, you can build it from <a href=\"https://github.com/Kilian/gatsby-plugin-segment-js\">my fork</a>.</p>\n<h2>In closing</h2>\n<p>If you work on a laptop or desktop with a good internet connection, the Time to Interactive is not so noticeable as ‚Äútime before you see something on your screen‚Äù, but it can have a big impact on your performance rating and interactivity, and because of that, your SEO. You should be extra careful when adding third party scripts to your page, and the best way to do that is to run Google Lighthouse. If you notice your Gatsby site has a bad performance score, make sure to check the Time to Interactive value. If it‚Äôs very high, try loading scripts only after a user has interacted with your website.</p>","frontmatter":{"title":"Speed up your time to interactive by delaying third party scripts","date":"October 12, 2019","description":null}}},"pageContext":{"slug":"/docs/blog/2019-08-30-speed-up-your-time-to-interactive-by-delaying-third-party-scripts/","previous":{"fields":{"slug":"/docs/blog/2019-10-08-hacktoberfest-2019/"},"frontmatter":{"title":"Gatsby Hacktoberfest 2019! üéÉüëª"}},"next":{"fields":{"slug":"/docs/blog/2019-10-15-free-headless-cms/"},"frontmatter":{"title":"3 Free Headless CMS's for Your Next Project"}}}}}