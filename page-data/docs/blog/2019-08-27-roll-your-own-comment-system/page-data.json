{"componentChunkName":"component---src-templates-blog-post-js","path":"/docs/blog/2019-08-27-roll-your-own-comment-system/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"3df7b249-aef2-5303-9f49-4ff0c317b63a","excerpt":"A while ago, I migrated my site from WordPress to Gatsby, a static site generator that runs on JavaScript/React. Gatsby recommends Disqus as a possible option…","html":"<p>A while ago, I <a href=\"/gatsby-bloga-2/blog/2019-03-21-migrating-from-wordpress-to-gatsby/\">migrated my site from WordPress to Gatsby</a>, a static site generator that runs on JavaScript/React. Gatsby <a href=\"/gatsby-bloga-2/docs/adding-comments/\">recommends Disqus</a> as a possible option for comments, and I briefly migrated all my comments over to it…until I looked at my site on a browser window without adblocker installed. I could see dozens of scripts injected into the site and even worse - truly egregious BuzzFeed-esque ads embedded between all the comments. I decided it immediately had to go.</p>\n<p>I had no comments for a bit, but I felt like I had no idea what the reception of my articles was without having any place for people to leave comments. Occasionally people will leave useful critiques or tips on tutorials that can help future visitors as well, so I wanted to try adding something very simple back in.</p>\n<p>I looked at all the options, but I really didn’t want to invest in setting up some third party code that I couldn’t rely on, or something with ads. So I figured I’d set one up myself. I designed the simplest possible comment system in a day, which this blog now runs on.</p>\n<p>Here’s some pros and cons to rolling your own comment system:</p>\n<h2>Pros</h2>\n<ul>\n<li>Free</li>\n<li>No ads</li>\n<li>No third party scripts injected into your site</li>\n<li>Complete control over functionality and design</li>\n<li>Can be as simple or complicated as you want</li>\n<li>Little to no spam because spambots aren’t set up to spam your custom content</li>\n<li>Easy to migrate - it all exists in one Heroku + Postgres server</li>\n</ul>\n<h2>Cons</h2>\n<ul>\n<li>More work to set up</li>\n<li>Less features</li>\n<li>Need to set up manual anti-spam measures and moderation</li>\n</ul>\n<p>If you’ve also struggled with this and wondered if there could be an easier way, or are just intrigued to see one person’s implementation, read on!</p>\n<h2>Introduction</h2>\n<p>This guide will <em>not</em> be a full, guided walkthrough - however, all the steps to create this are documented from start to finish in <a href=\"https://www.taniarascia.com/node-express-postgresql-heroku/\">Create and Deploy a Node.js, Express, &#x26; PostgreSQL REST API to Heroku</a>. The comments API is a Node + Express server connected to a Postgres instance hosted for free on the hobby tier of Heroku (Hopefully I don’t go over the 10,000 row limit any time soon). A combination of that article and what I’ve documented here can get you all the way to having your own comment system.</p>\n<blockquote>\n<p>Note: Comments overall aren’t a big deal to me, so I don’t care if I’m just running some little hobby API I created, or if it goes down for any reason. I think it should be pretty solid, but obviously if your needs are more professional than mine, you should go ahead and buy Disqus or something.</p>\n</blockquote>\n<p>The comments API consists of three parts:</p>\n<ul>\n<li><a href=\"#database\">Database</a></li>\n<li><a href=\"#api\">API Server</a></li>\n<li><a href=\"#front-end\">Front End</a></li>\n</ul>\n<p>The frontend is written for React, but if you know how to make a form and an API call, it can be easily adjusted to whatever static system you’re using.</p>\n<h2>Database</h2>\n<p>The first step assumes we’ll be setting up a Postgres database called <code class=\"language-text\">comments_api</code> with a <code class=\"language-text\">comments</code> table.</p>\n<p>In the <code class=\"language-text\">comments_api</code> database, I created a <code class=\"language-text\">comments</code> table, with <code class=\"language-text\">ID</code>, <code class=\"language-text\">name</code>, <code class=\"language-text\">date</code>, and <code class=\"language-text\">text</code>. The <code class=\"language-text\">slug</code> refers to the article URL - so for <code class=\"language-text\">https://example.com/how-to-bake-a-cake</code>, the slug would be <code class=\"language-text\">how-to-bake-a-cake</code>. Finally, I added <code class=\"language-text\">parent_comment_id</code> in case you want to have the ability to reply to comments.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">DATABASE</span> comments_api<span class=\"token punctuation\">;</span>\n\n\\c comments<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> comments <span class=\"token punctuation\">(</span>\n  ID <span class=\"token keyword\">SERIAL</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span>\n  name <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">date</span> TIMESTAMPTZ <span class=\"token keyword\">DEFAULT</span> <span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  slug <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  parent_comment_id <span class=\"token keyword\">INTEGER</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">text</span> <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span>\n  comments <span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">text</span><span class=\"token punctuation\">,</span> slug<span class=\"token punctuation\">,</span> parent_comment_id<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">VALUES</span>\n  <span class=\"token punctuation\">(</span><span class=\"token string\">'Bogus'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Testing the comments API'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'how-to-bake-a-cake'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>You could probably get more fancy with it and add website, email, upvotes and other features, but I just wanted it to be simple. I’m not adding in any login or OAuth/user authentication either, which makes it even more simple, but comes with the drawbacks of an anonymous online system.</p>\n<h2>API</h2>\n<p>In <a href=\"https://www.taniarascia.com/node-express-postgresql-heroku/\">Create and Deploy a Node.js, Express, &#x26; PostgreSQL REST API</a>, I document how to set up an Express server and make a Postgres pool connection.</p>\n<p>The aforementioned article goes much deeper into production level concerns of a Node.js server, such as error handling, validation, and brute force rate limiting.</p>\n<p>In our simplified, development example setup, we’ll require <code class=\"language-text\">express</code>, a Node.js server, plus <code class=\"language-text\">bodyParser</code> and <code class=\"language-text\">cors</code> to allow our app to parse and request the data, and <code class=\"language-text\">pg</code> to create a Postgres pool connection.</p>\n<blockquote>\n<p>This article is using default values for the Postgres connection - <code class=\"language-text\">user</code> as username, <code class=\"language-text\">password</code> as password, etc.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"express\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> bodyParser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"body-parser\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> cors <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cors\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> Pool <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pg\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> connectionString <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">postgresql://user:password@localhost:5432/comments</span><span class=\"token template-punctuation string\">`</span></span>\n\n<span class=\"token keyword\">const</span> pool <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Pool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> connectionString <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>bodyParser<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>bodyParser<span class=\"token punctuation\">.</span><span class=\"token function\">urlencoded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> extended<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">cors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// These are the functions we will be creating</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getComments</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getCommentsBySlug</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createComment</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">updateComment</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">deleteComment</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/comments\"</span><span class=\"token punctuation\">,</span> getComments<span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/comments/:slug\"</span><span class=\"token punctuation\">,</span> getCommentsBySlug<span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/comments\"</span><span class=\"token punctuation\">,</span> createComment<span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/comments/:id\"</span><span class=\"token punctuation\">,</span> updateComment<span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/comments/:id\"</span><span class=\"token punctuation\">,</span> deleteComment<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// Start server</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3002</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Server listening</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Remember that this example is simply for demonstration purposes and development.</p>\n<h3>Get all comments</h3>\n<p>First, I want a <code class=\"language-text\">GET</code> query that will just return everything to Node.js, ordered by date. This is just for me to have, so I can easily review all comments.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getComments</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  pool<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SELECT * FROM comments ORDER BY date DESC\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token punctuation\">,</span> results</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> error\n    <span class=\"token punctuation\">}</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">.</span>rows<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Get comments by page slug</h3>\n<p>More importantly, I want a query that will only return the comments that match the current page’s slug. This is the query I’ll use for each article.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getCommentsBySlug</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> slug <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>slug\n\n  pool<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"SELECT * FROM comments WHERE slug = $1 ORDER BY date DESC\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>slug<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token punctuation\">,</span> results</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> error\n      <span class=\"token punctuation\">}</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">.</span>rows<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Create a comment</h3>\n<p>Add the ability to <code class=\"language-text\">POST</code> a new comment, which people will be able to do through the HTML form.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createComment</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">,</span> slug<span class=\"token punctuation\">,</span> text <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n  <span class=\"token keyword\">const</span> parentCommentId <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>parentCommentId<span class=\"token punctuation\">)</span>\n\n  pool<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"INSERT INTO comments (name, slug, text, parent_comment_id) VALUES ($1, $2, $3, $4)\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">,</span> slug<span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">,</span> parentCommentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> error\n      <span class=\"token punctuation\">}</span>\n      response\n        <span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">201</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> status<span class=\"token operator\">:</span> <span class=\"token string\">\"success\"</span><span class=\"token punctuation\">,</span> message<span class=\"token operator\">:</span> <span class=\"token string\">\"New comment added.\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Update an existing comment</h3>\n<p>As moderator, I want the ability to update an existing comment. Commentors won’t be able to edit their comments, because they’re all anonymous. This will be a protected endpoint.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">updateComment</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">,</span> slug<span class=\"token punctuation\">,</span> text <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> parentCommentId <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>parentCommentId<span class=\"token punctuation\">)</span>\n\n  pool<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"UPDATE comments SET name = $1, slug = $2, text = $3, parent_comment_id = $4 WHERE id = $5\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">,</span> slug<span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">,</span> parentCommentId<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> error\n      <span class=\"token punctuation\">}</span>\n      response\n        <span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> status<span class=\"token operator\">:</span> <span class=\"token string\">\"success\"</span><span class=\"token punctuation\">,</span> message<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Comment modified with ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Delete a comment</h3>\n<p>Another protected endpoint, only I will have the ability to delete a comment.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">deleteComment</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n\n  pool<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DELETE FROM comments WHERE id = $1\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> error\n    <span class=\"token punctuation\">}</span>\n    response\n      <span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> status<span class=\"token operator\">:</span> <span class=\"token string\">\"success\"</span><span class=\"token punctuation\">,</span> message<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Comment deleted with ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Putting it together</h3>\n<p>We have our two <code class=\"language-text\">GET</code>s, a <code class=\"language-text\">POST</code>, <code class=\"language-text\">PUT</code>, and <code class=\"language-text\">DELETE</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/comments\"</span><span class=\"token punctuation\">,</span> getComments<span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/comments/:slug\"</span><span class=\"token punctuation\">,</span> getCommentsBySlug<span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/comments\"</span><span class=\"token punctuation\">,</span> createComment<span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/comments/:id\"</span><span class=\"token punctuation\">,</span> updateComment<span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/comments/:id\"</span><span class=\"token punctuation\">,</span> deleteComment<span class=\"token punctuation\">)</span></code></pre></div>\n<h2>Front End</h2>\n<p>Again, for the frontend I’m using React as an example, but the concept is the same for any template system. In whatever your post template file is, use JavaScript to make a <code class=\"language-text\">fetch</code> or <code class=\"language-text\">axios</code> call to your comment API, and save the data in state somewhere. Once I retrieve the JSON response from the API server, which will be an array of comment objects, I can pass it to wherever I’m displaying the comments.</p>\n<blockquote>\n<p>Sorry, I’m not using hooks yet. It’s okay, deep breath. We’ll get through this.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=templates/post.js\"><pre class=\"language-jsx:title=templates/post.js\"><code class=\"language-jsx:title=templates/post.js\">class PostTemplate {\n  ...\n  async componentDidMount() {\n    const { slug } = this.props.pageContext\n\n    try {\n      const response = await fetch(`https://www.example.com/comments/${slug}`)\n      const comments = await response.json()\n\n      this.setState({ comments })\n    } catch (error) {\n      this.setState({ error: true })\n    }\n  }</code></pre></div>\n<p>In this case, that will be a <code class=\"language-text\">Comments</code> component.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=templates/post.js\"><pre class=\"language-jsx:title=templates/post.js\"><code class=\"language-jsx:title=templates/post.js\">render() {\n  return (\n    &lt;div&gt;\n      {!error &amp;&amp; &lt;Comments commentsList={comments} slug={slug} /&gt;}\n    &lt;/div&gt;\n  )\n}</code></pre></div>\n<p>The <code class=\"language-text\">Comments</code> component will contain both the form to submit a comment, and the list of existing comments if there are any. So in state, I’ll save the comments list, and an object to store new comment state for the form.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=components/comments.js\"><pre class=\"language-jsx:title=components/comments.js\"><code class=\"language-jsx:title=components/comments.js\">import React, { Component } from &quot;react&quot;\nimport moment from &quot;moment&quot;\n\nclass Comments extends Component {\n  // You&#39;ll need a constructor() here if you&#39;re not using Babel transform-class-properties\n  initialState = {\n    comments: this.props.commentsList || [],\n    newComment: {\n      name: &quot;&quot;,\n      text: &quot;&quot;,\n      slug: this.props.slug,\n      parentCommentId: null,\n    },\n    submitting: false,\n    success: false,\n    error: false,\n  }\n\n  state = this.initialState\n}</code></pre></div>\n<p>I’ll admit this code is not the most pristine I’ve ever seen, but as I mentioned, I wrote the thing in a day, so feel free to refactor and write however you want.</p>\n<p>When a comment is submitted, I’ll use <code class=\"language-text\">fetch</code> once again, this time with the <code class=\"language-text\">post</code> method. If everything went through correctly, append the new comment to the comments array, and reset the new comment.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=components/comments.js\"><pre class=\"language-jsx:title=components/comments.js\"><code class=\"language-jsx:title=components/comments.js\">onSubmitComment = async event =&gt; {\n  event.preventDefault()\n\n  // Set this so the button can&#39;t be pressed repeatedly\n  this.setState({ submitting: true })\n\n  const { newComment, comments } = this.state\n  const { slug } = this.props\n\n  try {\n    // POST to /comments\n    const response = await fetch(&quot;https://www.example.com/comments&quot;, {\n      headers: {\n        Accept: &quot;application/json&quot;,\n        &quot;Content-Type&quot;: &quot;application/json&quot;,\n      },\n      method: &quot;post&quot;,\n      body: JSON.stringify(newComment),\n    })\n\n    // Append comment and reset newComment\n    this.setState(prevState =&gt; ({\n      ...prevState,\n      comments: [newComment, ...comments],\n      newComment: {\n        name: &quot;&quot;,\n        text: &quot;&quot;,\n        slug,\n        parentCommentId: null,\n      },\n      success: true,\n      error: false,\n    }))\n  } catch (error) {\n    this.setState({ ...this.initialState, error: true })\n  }\n}</code></pre></div>\n<p>I’ll also have an <code class=\"language-text\">onChange</code> handler for the form.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=components/comments.js\"><pre class=\"language-jsx:title=components/comments.js\"><code class=\"language-jsx:title=components/comments.js\">handleChange = event =&gt; {\n  const { newComment } = this.state\n  const { name, value } = event.target\n\n  this.setState({\n    newComment: { ...newComment, [name]: value },\n  })\n}</code></pre></div>\n<p>We can start the render lifecycle now.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=components/comments.js\"><pre class=\"language-jsx:title=components/comments.js\"><code class=\"language-jsx:title=components/comments.js\">render() {\n  const { submitting, success, error, comments, newComment: { name, text } } = this.state</code></pre></div>\n<p>I made some simple error or success messages to show after submitting the form.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=components/comments.js\"><pre class=\"language-jsx:title=components/comments.js\"><code class=\"language-jsx:title=components/comments.js\">const showError = () =&gt;\n  error &amp;&amp; (\n    &lt;div className=&quot;error&quot;&gt;\n      &lt;p&gt;Comment failed to submit.&lt;/p&gt;\n    &lt;/div&gt;\n  )\n\nconst showSuccess = () =&gt;\n  success &amp;&amp; (\n    &lt;div className=&quot;success&quot;&gt;\n      &lt;p&gt;Comment submitted!&lt;/p&gt;\n    &lt;/div&gt;\n  )</code></pre></div>\n<p>The comment form only consists of name and comment in my case, as I decided to go the <a href=\"https://sivers.org/\">Sivers</a> route and only allow comment replies by yours truly on the site.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=components/comments.js\"><pre class=\"language-jsx:title=components/comments.js\"><code class=\"language-jsx:title=components/comments.js\">const commentForm = () =&gt; (\n  &lt;form id=&quot;new-comment&quot; onSubmit={this.onSubmitComment}&gt;\n      &lt;label for=&quot;name&quot;&gt;\n      Name:\n    &lt;input\n      type=&quot;text&quot;\n      name=&quot;name&quot;\n      id=&quot;name&quot;\n      value={name}\n      onChange={this.handleChange}\n      maxLength=&quot;255&quot;\n      placeholder=&quot;Name&quot;\n      required\n    /&gt;\n    &lt;/label&gt;\n    &lt;label for=&quot;text&quot;&gt;\n    Comment\n    &lt;textarea\n      rows=&quot;2&quot;\n      cols=&quot;5&quot;\n      name=&quot;text&quot;\n      id=&quot;text&quot;\n      value={text}\n      onChange={this.handleChange}\n      placeholder=&quot;Comment&quot;\n      required\n    /&gt;\n    &lt;/label&gt;\n    &lt;button type=&quot;submit&quot; disabled={!name || !text || text.length &lt; 20 || submitting}&gt;\n      Submit\n    &lt;/button&gt;\n  &lt;/form&gt;\n}</code></pre></div>\n<p>Finally, we’ll display the form and the comments. I decided to either display the form or a success/error message. A visitor won’t be able to leave two comments in a row without reloading the page.</p>\n<p>After that, it’s just a matter of looping through the comments and displaying them. I’ve made comment replies incredibly simple - only one reply allowed per post, and no nesting.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx:title=components/comments.js\"><pre class=\"language-jsx:title=components/comments.js\"><code class=\"language-jsx:title=components/comments.js\">return (\n  &lt;section id=&quot;comments&quot;&gt;\n    {success || error ? showError() || showSuccess() : commentForm()}\n    {comments.length &gt; 0 &amp;&amp;\n      comments\n        .filter(comment =&gt; !comment.parent_comment_id)\n        .map((comment, i) =&gt; {\n          let child\n          if (comment.id) {\n            child = comments.find(c =&gt; comment.id == c.parent_comment_id)\n          }\n\n          return (\n            &lt;div className=&quot;comment&quot; key={i}&gt;\n              &lt;header&gt;\n                &lt;h2&gt;{comment.name}&lt;/h2&gt;\n                &lt;div className=&quot;comment-date&quot;&gt;\n                  {moment(comment.date).fromNow()}\n                &lt;/div&gt;\n              &lt;/header&gt;\n              &lt;p&gt;{comment.text}&lt;/p&gt;\n              {child &amp;&amp; (\n                &lt;div className=&quot;comment reply&quot;&gt;\n                  &lt;header&gt;\n                    &lt;h3&gt;{child.name}&lt;/h3&gt;\n                    &lt;div className=&quot;comment-date&quot;&gt;\n                      {moment(child.date).fromNow()}\n                    &lt;/div&gt;\n                  &lt;/header&gt;\n                  &lt;p&gt;{child.text}&lt;/p&gt;\n                &lt;/div&gt;\n              )}\n            &lt;/div&gt;\n          )\n        })}\n  &lt;/section&gt;\n)</code></pre></div>\n<h2>Conclusion</h2>\n<p>You’ll probably also want to add in some anti-spam moderation system, like adding a <code class=\"language-text\">moderated</code> column to the comments, setting it to <code class=\"language-text\">false</code> by default, and manually setting it to <code class=\"language-text\">true</code> if you approve the comment.</p>\n<p>I hope this helps out someone who wants a simple, free system for their own personal site. I like reinventing the wheel and making things from scratch. It’s fun, and I learn a lot.</p>\n<p>For more information on building contact forms with Gatsby, check out the <a href=\"/gatsby-bloga-2/docs/building-a-contact-form/\">docs reference guides</a>.</p>","frontmatter":{"title":"Roll Your Own Comment System","date":"August 27, 2019","description":null}}},"pageContext":{"slug":"/docs/blog/2019-08-27-roll-your-own-comment-system/","previous":{"fields":{"slug":"/docs/blog/2019-08-23-creating-a-purpose-driven-media-platform/"},"frontmatter":{"title":"Creating a purpose-driven media platform"}},"next":{"fields":{"slug":"/docs/blog/2019-08-30-diversity-and-inclusion/"},"frontmatter":{"title":"Gatsby’s Commitments to Diversity and Inclusion (D&I)"}}}}}