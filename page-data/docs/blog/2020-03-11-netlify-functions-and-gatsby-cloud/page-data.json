{"componentChunkName":"component---src-templates-blog-post-js","path":"/docs/blog/2020-03-11-netlify-functions-and-gatsby-cloud/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"82a7daf1-209a-56f3-8533-28060ec777f5","excerpt":"import netlifyFunctions from â€œ./gatsby-cloud.pngâ€ Every now and then, Gatsby developers find themselves needing a sprinkle of back-end code. We donâ€™tâ€¦","html":"<p>import netlifyFunctions from â€œ./gatsby-cloud.pngâ€</p>\n<p>Every now and then, Gatsby developers find themselves needing a sprinkle of back-end code. We donâ€™t necessarily need a whole server, and we certainly donâ€™t want to have to deal with things like load balancing and scaling. We just need some code to run not-in-the-browser.</p>\n<p>Case in point: when I was rebuilding my <a href=\"https://joshwcomeau.com/\">personal blog</a>, I wanted to track and display the number of likes each article gets, as well as the number of hits (for a retro-style hit counter).</p>\n<p>For these kinds of situations, <em>serverless functions</em> are perfect. They let us write small bits of Node.js code without worrying about where that code will run.</p>\n<p>My personal blog is built and deployed with <a href=\"https://www.gatsbyjs.com/cloud\">Gatsby Cloud</a>, a CI service for Gatsby sites, and itâ€™s hosted by <a href=\"https://www.netlify.com/\">Netlify</a>. Iâ€™m a very happy Netlify customer, and <a href=\"https://www.netlify.com/products/functions/\">Netlify Functions</a> seemed like the perfect service for my needs!</p>\n<p>Getting Gatsby Cloud and Netlify Functions to cooperate took a bit of tinkering, but happily it can be done! The solution I discovered feels robust and reliable, and my blog has been powered by these two services for several weeks now, without any issues.</p>\n<p>Today weâ€™ll look at how to use Netlify Functions for your Gatsby Cloud site.</p>\n<h2>What are Netlify Functions?</h2>\n<p>Netlify functions let you run event-driven server-side code, without worrying about running and maintaining a server. Itâ€™s a service that sits in front of AWS Lambda, and brushes away some of the thorns of working directly with Amazon Web Services.</p>\n<p>It allows you to write code like this, used by my blog to track hits:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> faunadb <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"faunadb\"</span><span class=\"token punctuation\">)</span>\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">handler</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Connect to the database</span>\n  <span class=\"token keyword\">const</span> q <span class=\"token operator\">=</span> faunadb<span class=\"token punctuation\">.</span>query\n  <span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">faunadb<span class=\"token punctuation\">.</span>Client</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    secret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">FAUNADB_SECRET</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Get the provided slug, and use it to look up</span>\n  <span class=\"token comment\">// the corresponding document.</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> slug <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> document <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>\n    q<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>q<span class=\"token punctuation\">.</span><span class=\"token function\">Match</span><span class=\"token punctuation\">(</span>q<span class=\"token punctuation\">.</span><span class=\"token function\">Index</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hits_by_slug\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> slug<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Increment the number of hits by 1</span>\n  <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>\n    q<span class=\"token punctuation\">.</span><span class=\"token function\">Update</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span>ref<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> hits<span class=\"token operator\">:</span> document<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>hits <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n    body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      success<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>When using Netlify for CI <em>and</em> deployments, you can pop this code in a <code class=\"language-text\">/functions</code> directory and the functions will get built and shipped whenever you push to GitHub. No manual steps needed ğŸ’¯.</p>\n<p>Learn more about Netlify Functions in <a href=\"https://docs.netlify.com/functions/overview/\">their documentation</a>.</p>\n<h2>What is Gatsby Cloud?</h2>\n<p>Gatsby Cloud is a service provided by Gatsby Inc. to manage deployments of Gatsby apps.</p>\n<p>Critically, Gatsby Cloud is <em>not</em> an alternative to Netlifyâ€”we still use CDN providers like Netlify or Amazon S3 to host your projects. Rather, Gatsby Cloud is a CI service that builds your site and distributes it for you.</p>\n<p><img\n  src={netlifyFunctions}\n  alt=\"Screenshot of Gatsby Cloud, showing a successful recent deploy.\"\n/></p>\n<p>There are lots of reasons to use Gatsby Cloud, but perhaps the most compelling reason for most developers is speed. Weâ€™re building specialized infrastructure which allows us to build large Gatsby sites in record time.</p>\n<h2>With our powers combinedâ€¦</h2>\n<p>The trouble is that when using Gatsby Cloud, we arenâ€™t doing any building on Netlify; we build the site ahead of time, and upload the files to Netlify. This deprives Netlify of the opportunity to package and ship our functions!</p>\n<p>Happily, we can work around this. Weâ€™ll dive into how this all works, but for eager beavers, hereâ€™s the code we need to add to <code class=\"language-text\">gatsby-node.js</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"path\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fs\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> zipFunctions <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"@netlify/zip-it-and-ship-it\"</span><span class=\"token punctuation\">)</span>\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onPostBuild</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> srcLocation <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">./functions</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> outputLocation <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">./public/functions</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">existsSync</span><span class=\"token punctuation\">(</span>outputLocation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">mkdirSync</span><span class=\"token punctuation\">(</span>outputLocation<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token function\">zipFunctions</span><span class=\"token punctuation\">(</span>srcLocation<span class=\"token punctuation\">,</span> outputLocation<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Gatsby build hooks</h3>\n<p>In my opinion, one of the coolest things about Gatsby.js is that you can â€œhook inâ€ to any of its build steps, like a lifecycle method.</p>\n<p><code class=\"language-text\">onPostBuild</code> runs right after the build completes. We can use it to prepare and copy the functions over to the right place, before itâ€™s handed off to Netlify.</p>\n<p>Learn more about Gatsby build hooks in <a href=\"/gatsby-bloga-2/docs/node-apis/\">our documentation</a>.</p>\n<h3>Zip It and Ship It</h3>\n<p>Remember when I mentioned that Netlify brushes away the thorns of working with AWS Lambda? One of those thorns is the quirk that every function needs to be its own packaged project.</p>\n<p>Letâ€™s say we have two functions, <code class=\"language-text\">track-hit.js</code> and <code class=\"language-text\">like-content.js</code>. And letâ€™s assume that they both use <code class=\"language-text\">faunadb</code>, a Node module. We need to produce two <code class=\"language-text\">.zip</code> files, with the following contents:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">.\nâ””â”€â”€ functions\n    â”œâ”€â”€ track-hit.zip\n    â”‚   â”œâ”€â”€ track-hit.js\n    â”‚   â””â”€â”€ node_modules\n    â”‚       â”œâ”€â”€ faunadb\n    â”‚       â”‚   â”œâ”€â”€ index.js\n    â”‚       â”‚   â””â”€â”€ (all the other stuff in this module)\n    â”‚       â”œâ”€â”€ some-faunadb-dependency\n    â”‚       â””â”€â”€ some-other-faunadb-dependency\n    â””â”€â”€ like-content.zip\n        â”œâ”€â”€ like-content.js\n        â””â”€â”€ node_modules\n            â”œâ”€â”€ faunadb\n            â”‚   â”œâ”€â”€ index.js\n            â”‚   â””â”€â”€ (all the other stuff in this module)\n            â”œâ”€â”€ some-faunadb-dependency\n            â””â”€â”€ some-other-faunadb-dependency</code></pre></div>\n<p>Because the folks at Netlify are wonderful wizards, they extracted the module that prepares functions and published it on npm as <code class=\"language-text\">@netlify/zip-it-and-ship-it</code>. This means we can leverage this critical part of Netlifyâ€™s build process even though we arenâ€™t building on Netlify.</p>\n<h3>Cold and warm builds</h3>\n<p>When we ship our built project over to Netlify, itâ€™s going to look for functions in a very specific place: <code class=\"language-text\">/public/functions</code>. We need to have our built, prepared functions hanging out in that directory. Before we can build and prep the functions with <code class=\"language-text\">zip-it-and-ship-it</code>, we need to create the directory first!</p>\n<p>This bit of code checks to see if the directory exists, and creates it if necessary:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">existsSync</span><span class=\"token punctuation\">(</span>outputLocation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  fs<span class=\"token punctuation\">.</span><span class=\"token function\">mkdirSync</span><span class=\"token punctuation\">(</span>outputLocation<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Why might the directory already exist? Gatsby Cloud maintains a cache, to speed up subsequent builds. A â€œcold buildâ€ will start from scratch, while a â€œwarm buildâ€ will reuse what it can. We need to ensure our build succeeds regardless of whether or not the directory has been cached.</p>\n<blockquote>\n<p>Node purists are probably aghast in horror at the fact that Iâ€™m using <code class=\"language-text\">existsSync</code> and <code class=\"language-text\">mkdirSync</code> instead of their default async versions. Because this is a build step, and not an active server, I couldnâ€™t see any compelling issue with doing it this way, and it makes the code a little simpler!</p>\n</blockquote>\n<h2>In conclusion</h2>\n<p>With a little bit of Node.js configuration, weâ€™re able to do some post-processing after the build, packaging up our functions and moving them to the spot Netlify expects to find them. When we push code to GitHub, Gatsby Cloud will run a new build, and then upload the resulting files to Netlify.</p>\n<p>If you already have a Gatsby Cloud site, and youâ€™re considering using serverless functions, I can say unequivocally that Netlify makes the experience seamless and painless, and their generous pricing model means that you can experiment with them for free.</p>\n<p>If you already use Netlify Functions and are considering moving your Gatsby site to Gatsby Cloud, we hope youâ€™ll give us a shot! One of our main focuses on the Gatsby Cloud team is to reduce the build time for complex / large sites. If youâ€™ve been watching build times climb, weâ€™re doing our best to speed things up. âš¡ï¸</p>","frontmatter":{"title":"Using Netlify Functions with Gatsby Cloud","date":"March 25, 2020","description":null}}},"pageContext":{"slug":"/docs/blog/2020-03-11-netlify-functions-and-gatsby-cloud/","previous":{"fields":{"slug":"/docs/blog/2020-03-23-Flying-Feature-Flags-with-New-LaunchDarkly-plugin/"},"frontmatter":{"title":"Flying Feature Flags with LaunchDarklyâ€™s New Plugin for Gatsby"}},"next":{"fields":{"slug":"/docs/blog/100days/comments/"},"frontmatter":{"title":"Challenge 13 - Enable Comments to Your Gatsby Blog"}}}}}